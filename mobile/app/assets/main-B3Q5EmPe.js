var e,t,s=Object.defineProperty,n=Object.getOwnPropertyNames,i=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,r=(e,t,n)=>t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,l=(e,t)=>{for(var s in t||(t={}))o.call(t,s)&&r(e,s,t[s]);if(i)for(var s of i(t))a.call(t,s)&&r(e,s,t[s]);return e},c=(e,t,s)=>new Promise((n,i)=>{var o=e=>{try{r(s.next(e))}catch(t){i(t)}},a=e=>{try{r(s.throw(e))}catch(t){i(t)}},r=e=>e.done?n(e.value):Promise.resolve(e.value).then(o,a);r((s=s.apply(e,t)).next())}),u=(e={"assets/main-B3Q5EmPe.js"(e){!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const t="/wp-json/wp/v2/users/me",s="/wp-json/ai-commander/v1/realtime/session",n="/wp-json/ai-commander/v1/realtime/tool",i="/wp-json/ai-commander/v1/read-text",o="https://api.openai.com/v1/realtime",a="gpt-4o-realtime-preview-2024-12-17",r=48e3,u=1,d=16,h=!1,m=!1,p=!1,g=96e3,S=5e3,C="inofficina_site_url",v="inofficina_username",y="inofficina_app_password",b="Premi per iniziare",E="Connessione in corso...",T="In ascolto...",f="Elaborazione...",M="Premi per interrompere",w="Esecuzione comando...",k="In attesa...",A="Errore",P="URL non valido. Inserisci un URL completo (es. https://www.tuaofficina.it)",I="Credenziali non valide. Verifica nome utente e password.",L="Accesso negato. Verifica i permessi utente sul sito.",B="Impossibile connettersi al sito WordPress",x="Impossibile avviare la sessione",_="Tool execution failed",D="Network error",U="Data channel not open",H="Errore nella riproduzione audio personalizzato.",O="Errore di comunicazione",R="Errore sconosciuto";class j{constructor(e,t){this.siteUrl=e,this.bearerToken=t}testConnection(){return c(this,null,function*(){const e=yield fetch(`${this.siteUrl}${t}`,{method:"GET",mode:"cors",credentials:"omit",headers:{Authorization:`Basic ${this.bearerToken}`}});if(!e.ok){if(401===e.status)throw new Error(I);if(403!==e.status)throw new Error(B);try{const t=yield e.json();if(!(t&&t.id&&t.name))throw new Error(L);console.log("Authentication successful despite 403 status")}catch(s){throw new Error(L)}}})}createSession(){return c(this,null,function*(){var e;const t=yield fetch(`${this.siteUrl}${s}`,{method:"POST",credentials:"omit",headers:{"Content-Type":"application/json",Authorization:`Basic ${this.bearerToken}`},body:JSON.stringify({})});if(!t.ok){const e=yield t.text();throw new Error(`${x}: ${e}`)}const n=yield t.json();if(!(null==(e=n.client_secret)?void 0:e.value))throw new Error("Invalid session response");return n})}executeTool(e){return c(this,null,function*(){const t=yield fetch(`${this.siteUrl}${n}`,{method:"POST",credentials:"omit",headers:{"Content-Type":"application/json",Authorization:`Basic ${this.bearerToken}`},body:JSON.stringify(e)});return yield t.json()})}getTextToSpeech(e){return c(this,null,function*(){const t=yield fetch(`${this.siteUrl}${i}`,{method:"POST",credentials:"omit",headers:{"Content-Type":"application/json",Authorization:`Basic ${this.bearerToken}`},body:JSON.stringify({text:e})});if(!t.ok)throw new Error(`TTS request failed with status ${t.status}`);return yield t.blob()})}static generateBearerToken(e,t){return btoa(`${e}:${t}`)}}class N{constructor(){this.peerConnection=null,this.dataChannel=null,this.localStream=null}startSession(e){return c(this,arguments,function*(e,t=a,s={}){this.peerConnection=new RTCPeerConnection,s.onTrack&&(this.peerConnection.ontrack=s.onTrack),this.peerConnection.getTransceivers().forEach(e=>{var t;if("audio"===(null==(t=e.sender.track)?void 0:t.kind)){const t=e.sender.getParameters();t.encodings=[{maxBitrate:g}],e.sender.setParameters(t)}}),this.localStream=yield navigator.mediaDevices.getUserMedia({audio:{sampleRate:r,channelCount:u,sampleSize:d,echoCancellation:h,noiseSuppression:m,autoGainControl:p}}),this.localStream.getTracks().forEach(e=>{this.peerConnection.addTrack(e,this.localStream)}),this.dataChannel=this.peerConnection.createDataChannel("oai-events",{ordered:!0}),s.onDataChannelOpen&&(this.dataChannel.onopen=s.onDataChannelOpen),s.onDataChannelMessage&&(this.dataChannel.onmessage=s.onDataChannelMessage),s.onDataChannelError&&(this.dataChannel.onerror=s.onDataChannelError);const n=yield this.peerConnection.createOffer();yield this.peerConnection.setLocalDescription(n);const i=yield fetch(`${o}?model=${t}`,{method:"POST",body:n.sdp,headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/sdp"}});if(!i.ok)throw new Error(`SDP negotiation failed: ${i.status}`);const l=yield i.text();yield this.peerConnection.setRemoteDescription({type:"answer",sdp:l})})}sendEvent(e){if(!this.dataChannel||"open"!==this.dataChannel.readyState)throw new Error("Data channel not open");this.dataChannel.send(JSON.stringify(e))}muteMicrophone(){this.localStream&&this.localStream.getAudioTracks().forEach(e=>{e.enabled=!1})}unmuteMicrophone(){this.localStream&&this.localStream.getAudioTracks().forEach(e=>{e.enabled=!0})}updateTurnDetection(e){console.log("[WebRTCService] updateTurnDetection called with mode:",e);const t={type:"session.update",session:{turn_detection:"server_vad"===e?{type:"server_vad",threshold:.5,prefix_padding_ms:300,silence_duration_ms:200}:null}};console.log("[WebRTCService] Sending session.update event:",t),this.sendEvent(t)}closeSession(){this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=null),this.dataChannel&&(this.dataChannel.close(),this.dataChannel=null),this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null)}}class z{constructor(e){this.apiService=e,this.isMobileAudioUnlocked=!1,this.globalAudioContext=null,this.isPlayingCustomTts=!1,this.currentAudioElement=null}unlockMobileAudio(e){if(!this.isMobileAudioUnlocked){this.isMobileAudioUnlocked=!0;try{this.globalAudioContext=this.globalAudioContext||new(window.AudioContext||window.webkitAudioContext),"suspended"===this.globalAudioContext.state&&this.globalAudioContext.resume()}catch(t){console.warn("AudioContext initialisation failed:",t)}if(e){const t=e.muted;e.muted=!0;const s=e.play();s&&"function"==typeof s.then?s.then(()=>{e.pause(),e.currentTime=0,e.muted=t,console.log("[AI-Commander] Mobile audio unlocked")}).catch(s=>{console.warn("Mobile audio unlock play() rejected:",s),e.muted=t}):e.muted=t}}}playCustomTtsAudio(e,t,s,n){return c(this,null,function*(){if(e){console.log("[AudioService] Playing custom TTS for:",e);try{this.isPlayingCustomTts=!0,this.currentAudioElement=t,s&&s(),console.log("[AudioService] Fetching TTS audio from API...");const n=yield this.apiService.getTextToSpeech(e);if(console.log("[AudioService] Received audio blob, size:",n.size),!this.isPlayingCustomTts||!t)return;t.dataset.objectUrl&&(URL.revokeObjectURL(t.dataset.objectUrl),delete t.dataset.objectUrl),t.srcObject=null;const i=URL.createObjectURL(n);t.dataset.objectUrl=i,t.src=i,yield t.play(),yield new Promise((e,s)=>{const n=()=>{this.isPlayingCustomTts||(t.pause(),e())};t.onended=()=>e(),t.onerror=()=>s(new Error("Audio playback error"));const i=setInterval(()=>{n(),this.isPlayingCustomTts||clearInterval(i)},100),o=e;e=()=>{clearInterval(i),o()}}),URL.revokeObjectURL(i),delete t.dataset.objectUrl}catch(i){throw console.error("Error during custom TTS playback:",i),new Error(H)}finally{this.isPlayingCustomTts=!1,this.currentAudioElement=null,n&&n()}}else console.log("[AudioService] No text provided for TTS")})}interruptCustomTts(){this.isPlayingCustomTts&&this.currentAudioElement&&(this.isPlayingCustomTts=!1,this.currentAudioElement.pause(),this.currentAudioElement.currentTime=0,this.currentAudioElement.dataset.objectUrl&&(URL.revokeObjectURL(this.currentAudioElement.dataset.objectUrl),delete this.currentAudioElement.dataset.objectUrl),console.log("Custom TTS interrupted by user"))}cleanup(e){this.interruptCustomTts(),e&&(e.pause(),e.currentTime=0,e.srcObject=null,e.src="",e.dataset.objectUrl&&(URL.revokeObjectURL(e.dataset.objectUrl),delete e.dataset.objectUrl),e.onended=null)}get isPlayingTts(){return this.isPlayingCustomTts}}class ${constructor(e,t,s){this.stateManager=e,this.apiService=t,this.audioElement=s,this.webrtcService=new N,this.audioService=new z(t)}startSession(){return c(this,null,function*(){var e;try{this.stateManager.setState({status:"connecting",messages:[],toolCallQueue:[],currentToolCallId:null});const t=yield this.apiService.createSession();this.stateManager.setSessionData(t.client_secret.value,t.modalities||["text","audio"]),console.log("Session modalities:",t.modalities),console.log("Custom TTS enabled:",!(null==(e=t.modalities)?void 0:e.includes("audio"))),yield this.webrtcService.startSession(t.client_secret.value,t.model,{onDataChannelOpen:()=>{this.stateManager.updateStatus("recording")},onDataChannelMessage:e=>this.handleServerEvent(e),onDataChannelError:e=>{console.error("Data channel error:",e),this.handleError(O)},onTrack:e=>{this.audioElement&&e.streams&&e.streams[0]&&(this.audioElement.srcObject=e.streams[0],this.audioElement.play().catch(e=>console.error("Audio play error:",e)))}})}catch(t){console.error("Session start error:",t),this.handleError(t.message||x),this.stopSession()}})}stopSession(){this.stateManager.getState().isPlayingCustomTts&&this.audioService.interruptCustomTts(),this.webrtcService.closeSession(),this.audioService.cleanup(this.audioElement),this.stateManager.updateStatus("disconnected"),this.stateManager.updateTranscript("")}setVadEnabled(e){console.log("[SessionManager] setVadEnabled called with:",e);try{this.webrtcService.updateTurnDetection(e?"server_vad":"none"),console.log(`[SessionManager] VAD ${e?"enabled":"disabled"} - session update sent`),e&&(console.log("[SessionManager] Committing audio buffer after press-to-talk"),this.webrtcService.sendEvent({type:"input_audio_buffer.commit"}),console.log("[SessionManager] Creating response after press-to-talk"),this.webrtcService.sendEvent({type:"response.create"}))}catch(t){console.error("[SessionManager] Failed to update VAD:",t)}}handleServerEvent(e){return c(this,null,function*(){try{const t=JSON.parse(e.data);console.log("Server event:",t.type,t);const s=this.stateManager.getState();switch(t.type){case"input_audio_buffer.speech_started":this.webrtcService.unmuteMicrophone(),this.stateManager.updateStatus("recording");break;case"input_audio_buffer.speech_stopped":this.stateManager.updateStatus("processing");break;case"conversation.item.input_audio_transcription.completed":this.stateManager.addMessage({type:"user",content:t.transcript});break;case"response.created":this.stateManager.updateTranscript("");break;case"response.audio_transcript.delta":case"response.text.delta":this.stateManager.appendTranscript(t.delta||"");break;case"response.audio.delta":s.isCustomTtsEnabled||this.stateManager.updateStatus("speaking");break;case"response.function_call_arguments.delta":"tool_wait"!==s.status&&this.stateManager.updateStatus("tool_wait");break;case"response.done":yield this.handleResponseDone(t);break;case"output_audio_buffer.stopped":s.isCustomTtsEnabled||this.stateManager.updateStatus("idle");break;case"error":console.error("API Error:",t),this.handleError(t.message||R)}}catch(t){console.error("Error parsing server event:",t)}})}handleResponseDone(e){return c(this,null,function*(){var t,s,n,i;if(this.stateManager.updateTranscript(""),"failed"===e.response.status)return void this.stateManager.updateStatus("error");const o=null==(i=null==(n=null==(s=null==(t=e.response)?void 0:t.output)?void 0:s[0])?void 0:n.content)?void 0:i[0],a=(null==o?void 0:o.text)||(null==o?void 0:o.transcript);a&&this.stateManager.addMessage({type:"assistant",content:a}),this.stateManager.getState().isCustomTtsEnabled&&a&&(yield this.playCustomTts(a)),e.response.output&&e.response.output.forEach(e=>{"function_call"===e.type&&e.call_id&&e.name&&e.arguments&&this.stateManager.queueToolCall({name:e.name,arguments:e.arguments,call_id:e.call_id})});const r=this.stateManager.dequeueToolCall();r&&(yield this.processToolCall(r))})}playCustomTts(e){return c(this,null,function*(){console.log("[SessionManager] Starting custom TTS for text:",e);try{yield this.audioService.playCustomTtsAudio(e,this.audioElement,()=>{console.log("[SessionManager] Custom TTS started"),this.stateManager.setPlayingCustomTts(!0),this.stateManager.updateStatus("speaking"),this.webrtcService.muteMicrophone()},()=>{console.log("[SessionManager] Custom TTS ended"),"disconnected"!==this.stateManager.getState().status&&(this.stateManager.setPlayingCustomTts(!1),this.webrtcService.unmuteMicrophone(),this.stateManager.updateStatus("recording"))})}catch(t){console.error("Custom TTS error:",t),"disconnected"!==this.stateManager.getState().status&&this.handleError(H)}})}processToolCall(e){return c(this,null,function*(){try{const t=yield this.apiService.executeTool({tool_name:e.name,arguments:e.arguments});t.error?this.sendFunctionResult(e.call_id,{error:!0,message:t.message||_}):this.sendFunctionResult(e.call_id,t)}catch(s){this.sendFunctionResult(e.call_id,{error:!0,message:D})}const t=this.stateManager.dequeueToolCall();t&&(yield this.processToolCall(t))})}sendFunctionResult(e,t){try{this.webrtcService.sendEvent({type:"conversation.item.create",item:{type:"function_call_output",call_id:e,output:JSON.stringify(t)}}),this.webrtcService.sendEvent({type:"response.create"})}catch(s){this.handleError(U)}}interruptTts(){this.stateManager.getState().isPlayingCustomTts?this.audioService.interruptCustomTts():this.stopSession()}handleError(e){console.error("Error:",e),this.stateManager.updateStatus("error")}}class F{constructor(e){this.elements=e,this.typingMessageDiv=null}showConfigScreen(){this.elements.configScreen.style.display="flex",this.elements.mainApp.classList.remove("active")}showMainApp(){this.elements.configScreen.style.display="none",this.elements.mainApp.classList.add("active")}showError(e){this.elements.configError.textContent=e,this.elements.configError.style.display="block",setTimeout(()=>{this.elements.configError.style.display="none"},S)}showLoading(e){this.elements.loadingOverlay.style.display=e?"flex":"none"}toggleSettingsMenu(){this.elements.settingsMenu.classList.toggle("active")}hideSettingsMenu(){this.elements.settingsMenu.classList.remove("active")}clearMessages(){this.elements.chatContainer.innerHTML="",this.elements.chatContainer.appendChild(this.elements.emptyState)}addMessage(e){this.elements.emptyState.parentNode&&this.elements.emptyState.remove();const t=document.createElement("div");t.className=`chat-message ${e.type}`;const s=document.createElement("div");s.className="message-bubble",s.textContent=e.content,t.appendChild(s),this.elements.chatContainer.appendChild(t),this.elements.chatContainer.scrollTop=this.elements.chatContainer.scrollHeight}showTypingIndicator(){this.elements.emptyState.parentNode&&this.elements.emptyState.remove(),this.typingMessageDiv=document.createElement("div"),this.typingMessageDiv.className="chat-message assistant",this.typingMessageDiv.id="typingMessage";const e=document.createElement("div");e.className="message-bubble typing",e.innerHTML='\n      <span class="typing-dot"></span>\n      <span class="typing-dot"></span>\n      <span class="typing-dot"></span>\n    ',this.typingMessageDiv.appendChild(e),this.elements.chatContainer.appendChild(this.typingMessageDiv),this.elements.chatContainer.scrollTop=this.elements.chatContainer.scrollHeight}updateTypingMessage(e){if(this.typingMessageDiv&&e){const t=this.typingMessageDiv.querySelector(".message-bubble");t&&(t.className="message-bubble",t.textContent=e,this.elements.chatContainer.scrollTop=this.elements.chatContainer.scrollHeight)}}hideTypingIndicator(){this.typingMessageDiv&&(this.typingMessageDiv.remove(),this.typingMessageDiv=null)}hasTypingIndicator(){return null!==this.typingMessageDiv}populateConfigForm(e,t){this.elements.siteUrlInput.value=e,this.elements.usernameInput.value=t,this.elements.appPasswordInput.value=""}clearConfigForm(){this.elements.siteUrlInput.value="",this.elements.usernameInput.value="",this.elements.appPasswordInput.value=""}disableConnectButton(e,t){this.elements.connectBtn.disabled=e,t&&(this.elements.connectBtn.textContent=t)}}class V{constructor(e,t,s){this.currentState="disconnected",this.pressTimer=null,this.isPressAndHold=!1,this.pressStartTime=0,this.PRESS_HOLD_DELAY=300,this.MIN_CLICK_TIME=50,this.buttonElement=e,this.statusElement=t,this.callbacks=s,this.setupEventListeners()}setupEventListeners(){this.buttonElement.addEventListener("click",()=>{this.isPressAndHold||0!==this.pressStartTime||this.handleClick()}),this.buttonElement.addEventListener("mousedown",e=>this.handlePressStart(e)),this.buttonElement.addEventListener("mouseup",e=>this.handlePressEnd(e)),this.buttonElement.addEventListener("mouseleave",e=>this.handlePressCancel(e)),this.buttonElement.addEventListener("touchstart",e=>this.handlePressStart(e),{passive:!1}),this.buttonElement.addEventListener("touchend",e=>this.handlePressEnd(e),{passive:!1}),this.buttonElement.addEventListener("touchcancel",e=>this.handlePressCancel(e))}handlePressStart(e){console.log("[MicButton] Press start event:",e.type,"Current state:",this.currentState),"touchstart"===e.type&&e.preventDefault(),this.pressStartTime=Date.now(),this.isPressAndHold=!1,"recording"===this.currentState?(console.log("[MicButton] Starting press-and-hold timer (300ms)"),this.pressTimer=window.setTimeout(()=>{this.isPressAndHold=!0,console.log("[MicButton] Press-and-hold ACTIVATED"),this.buttonElement.classList.add("press-and-hold"),this.callbacks.onPressAndHoldStart&&(console.log("[MicButton] Calling onPressAndHoldStart callback"),this.callbacks.onPressAndHoldStart())},this.PRESS_HOLD_DELAY)):console.log("[MicButton] Not in recording state, skipping press-and-hold")}handlePressEnd(e){const t=Date.now()-this.pressStartTime;console.log("[MicButton] Press end event:",e.type,"Duration:",t,"ms","isPressAndHold:",this.isPressAndHold),"touchend"===e.type&&e.preventDefault(),this.pressTimer&&(clearTimeout(this.pressTimer),this.pressTimer=null),this.isPressAndHold&&this.callbacks.onPressAndHoldEnd?(console.log("[MicButton] Ending press-and-hold, calling onPressAndHoldEnd callback"),this.buttonElement.classList.remove("press-and-hold"),this.callbacks.onPressAndHoldEnd(),this.isPressAndHold=!1):this.pressStartTime>0&&t>=this.MIN_CLICK_TIME&&t<this.PRESS_HOLD_DELAY&&(console.log("[MicButton] Normal click detected, calling handleClick()"),this.handleClick()),this.isPressAndHold=!1,this.pressStartTime=0}handlePressCancel(e){console.log("[MicButton] Press cancelled"),this.pressTimer&&(clearTimeout(this.pressTimer),this.pressTimer=null),this.isPressAndHold&&this.callbacks.onPressAndHoldEnd&&(console.log("[MicButton] Press-and-hold cancelled, calling onPressAndHoldEnd"),this.buttonElement.classList.remove("press-and-hold"),this.callbacks.onPressAndHoldEnd()),this.isPressAndHold=!1,this.pressStartTime=0}handleClick(){switch(this.currentState){case"disconnected":case"error":this.callbacks.onStartRecording();break;case"speaking":this.callbacks.onInterruptTts();break;case"recording":case"processing":case"tool_wait":case"idle":this.callbacks.onStopRecording();break;case"connecting":break;default:console.warn("Unknown mic button state:",this.currentState)}}setState(e,t={}){console.log(`Mic button: ${this.currentState} → ${e}`),this.currentState=e,this.updateUI(e,t)}updateUI(e,t={}){switch(this.buttonElement.className="mic-button",this.buttonElement.innerHTML="",this.buttonElement.disabled=!1,e){case"disconnected":this.statusElement.textContent=b,this.statusElement.className="status-text",this.buttonElement.innerHTML=this.getMicIcon();break;case"connecting":this.statusElement.textContent=E,this.statusElement.className="status-text",this.buttonElement.innerHTML='<div class="spinner"></div>',this.buttonElement.disabled=!0;break;case"recording":this.statusElement.textContent=T,this.statusElement.className="status-text",this.buttonElement.classList.add("recording"),this.buttonElement.innerHTML=this.getSoundWaveIcon();break;case"processing":this.statusElement.textContent=f,this.statusElement.className="status-text",this.buttonElement.innerHTML='<div class="spinner"></div>';break;case"speaking":this.statusElement.textContent=M,this.statusElement.className="status-text",this.buttonElement.disabled=!1,this.buttonElement.innerHTML=this.getStopIcon();break;case"tool_wait":this.statusElement.textContent=w,this.statusElement.className="status-text",this.buttonElement.innerHTML='<div class="spinner"></div>';break;case"idle":this.statusElement.textContent=k,this.statusElement.className="status-text",this.buttonElement.innerHTML=this.getStopIcon();break;case"error":this.statusElement.textContent=t.message||A,this.statusElement.className="status-text error",this.buttonElement.innerHTML=this.getMicIcon()}}getMicIcon(){return'\n      <svg viewBox="0 0 24 24" fill="currentColor">\n        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>\n        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>\n      </svg>\n    '}getStopIcon(){return'\n      <svg viewBox="0 0 24 24" fill="currentColor">\n        <rect x="6" y="6" width="12" height="12" rx="2"/>\n      </svg>\n    '}getSoundWaveIcon(){return'\n      <div class="sound-wave">\n        <span class="sound-bar"></span>\n        <span class="sound-bar"></span>\n        <span class="sound-bar"></span>\n        <span class="sound-bar"></span>\n        <span class="sound-bar"></span>\n      </div>\n    '}}class q{constructor(e,t){this.elements=e,this.stateManager=t,this.sessionManager=null,this.apiService=null,this.audioService=null,this.lastMessageCount=0,this.uiController=new F(e),this.micController=new V(e.micButton,e.statusText,{onStartRecording:()=>this.startRecordingSession(),onStopRecording:()=>this.stopRecordingSession(),onInterruptTts:()=>this.interruptTts(),onPressAndHoldStart:()=>this.handlePressAndHoldStart(),onPressAndHoldEnd:()=>this.handlePressAndHoldEnd()})}init(){return c(this,null,function*(){this.setupEventListeners(),this.stateManager.subscribe(e=>this.onStateChange(e));const e=this.stateManager.getState();e.siteUrl&&this.generateBearerToken()?(this.elements.siteUrlInput.value=e.siteUrl,this.elements.usernameInput.value=e.username,this.uiController.showMainApp()):this.uiController.showConfigScreen()})}setupEventListeners(){this.elements.configForm.addEventListener("submit",e=>this.handleConfigSubmit(e)),this.elements.settingsBtn.addEventListener("click",e=>{e.stopPropagation(),this.uiController.toggleSettingsMenu()}),this.elements.changeConfigBtn.addEventListener("click",()=>{this.uiController.hideSettingsMenu(),this.uiController.showConfigScreen(),this.uiController.populateConfigForm(this.stateManager.getState().siteUrl,this.stateManager.getState().username)}),this.elements.logoutBtn.addEventListener("click",()=>this.handleLogout()),this.elements.micButton.addEventListener("click",()=>{this.audioService&&this.audioService.unlockMobileAudio(this.elements.remoteAudio)},{once:!0}),document.addEventListener("click",e=>{this.elements.settingsBtn.contains(e.target)||this.elements.settingsMenu.contains(e.target)||this.uiController.hideSettingsMenu()})}onStateChange(e){this.micController.setState(e.status),e.currentTranscript?(this.uiController.hasTypingIndicator()||this.uiController.showTypingIndicator(),this.uiController.updateTypingMessage(e.currentTranscript)):this.uiController.hideTypingIndicator(),e.messages.length!==this.lastMessageCount&&(0===e.messages.length?(this.uiController.clearMessages(),this.lastMessageCount=0):e.messages.length>this.lastMessageCount?(e.messages.slice(this.lastMessageCount).forEach(e=>this.uiController.addMessage(e)),this.lastMessageCount=e.messages.length):(this.uiController.clearMessages(),e.messages.forEach(e=>this.uiController.addMessage(e)),this.lastMessageCount=e.messages.length))}generateBearerToken(){const e=localStorage.getItem(y),t=this.stateManager.getState();if(t.username&&e){const s=j.generateBearerToken(t.username,e);return this.stateManager.setState({bearerToken:s}),!0}return!1}handleConfigSubmit(e){return c(this,null,function*(){e.preventDefault();const t=this.elements.siteUrlInput.value.trim(),s=this.elements.usernameInput.value.trim(),n=this.elements.appPasswordInput.value.trim();if(!t||!s||!n)return;try{if(!new URL(t).protocol.startsWith("http"))throw new Error("URL deve iniziare con http:// o https://")}catch(o){return void this.uiController.showError(P)}const i=j.generateBearerToken(s,n);this.uiController.disableConnectButton(!0,"Connessione...");try{const e=new j(t,i);yield e.testConnection();const o=t.replace(/\/$/,"");this.stateManager.setSiteConfig(o,s,i),localStorage.setItem(y,n),yield this.initializeServices(o,i),this.uiController.showMainApp()}catch(o){this.uiController.showError(o.message||"Impossibile connettersi. Verifica i dati e riprova.")}finally{this.uiController.disableConnectButton(!1,"Connetti")}})}handleLogout(){confirm("Vuoi disconnetterti e cancellare le credenziali salvate?")&&(this.stateManager.clearSiteConfig(),this.uiController.clearConfigForm(),this.uiController.hideSettingsMenu(),this.uiController.showConfigScreen(),this.stopRecordingSession())}startRecordingSession(){return c(this,null,function*(){if(!this.sessionManager){const t=this.stateManager.getState();if(!t.siteUrl||!t.bearerToken)return this.uiController.showError("Credenziali non trovate. Accedi nuovamente."),void this.uiController.showConfigScreen();try{this.uiController.showLoading(!0),yield this.initializeServices(t.siteUrl,t.bearerToken)}catch(e){return console.error("Failed to initialize services:",e),this.uiController.showLoading(!1),this.uiController.showError("Sessione scaduta. Accedi nuovamente."),void this.uiController.showConfigScreen()}}this.uiController.showLoading(!0);try{yield this.sessionManager.startSession()}catch(e){console.error("Failed to start session:",e)}finally{this.uiController.showLoading(!1)}})}stopRecordingSession(){this.sessionManager&&this.sessionManager.stopSession(),this.uiController.hideTypingIndicator()}interruptTts(){this.sessionManager&&this.sessionManager.interruptTts()}handlePressAndHoldStart(){console.log("[App] handlePressAndHoldStart called, sessionManager exists:",!!this.sessionManager),this.sessionManager?this.sessionManager.setVadEnabled(!1):console.log("[App] No sessionManager available")}handlePressAndHoldEnd(){console.log("[App] handlePressAndHoldEnd called, sessionManager exists:",!!this.sessionManager),this.sessionManager?this.sessionManager.setVadEnabled(!0):console.log("[App] No sessionManager available")}initializeServices(e,t){return c(this,null,function*(){const s=new j(e,t);yield s.testConnection(),this.apiService=s,this.audioService=new z(s),this.sessionManager=new $(this.stateManager,s,this.elements.remoteAudio)})}}class J{constructor(){this.listeners=[],this.state={siteUrl:localStorage.getItem(C)||"",username:localStorage.getItem(v)||"",bearerToken:null,sessionToken:null,status:"disconnected",messages:[],currentTranscript:"",peerConnection:null,dataChannel:null,localStream:null,toolCallQueue:[],currentToolCallId:null,isCustomTtsEnabled:!1,sessionModalities:[],isPlayingCustomTts:!1}}getState(){return this.state}setState(e){this.state=l(l({},this.state),e),this.notifyListeners()}updateStatus(e){this.setState({status:e})}addMessage(e){this.setState({messages:[...this.state.messages,e]})}clearMessages(){this.setState({messages:[]})}setSiteConfig(e,t,s){this.setState({siteUrl:e,username:t,bearerToken:s}),localStorage.setItem(C,e),localStorage.setItem(v,t)}clearSiteConfig(){this.setState({siteUrl:"",username:"",bearerToken:null}),localStorage.removeItem(C),localStorage.removeItem(v),localStorage.removeItem(y)}setSessionData(e,t){const s=!t.includes("audio");this.setState({sessionToken:e,sessionModalities:t,isCustomTtsEnabled:s})}updateTranscript(e){this.setState({currentTranscript:e})}appendTranscript(e){this.setState({currentTranscript:this.state.currentTranscript+e})}queueToolCall(e){this.setState({toolCallQueue:[...this.state.toolCallQueue,e]})}dequeueToolCall(){const[e,...t]=this.state.toolCallQueue;return this.setState({toolCallQueue:t,currentToolCallId:(null==e?void 0:e.call_id)||null}),e}setPlayingCustomTts(e){this.setState({isPlayingCustomTts:e})}subscribe(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(t=>t!==e)}}notifyListeners(){this.listeners.forEach(e=>e(this.state))}}document.addEventListener("DOMContentLoaded",()=>c(e,null,function*(){const e={configScreen:document.getElementById("configScreen"),mainApp:document.getElementById("mainApp"),configForm:document.getElementById("configForm"),siteUrlInput:document.getElementById("siteUrl"),usernameInput:document.getElementById("username"),appPasswordInput:document.getElementById("appPassword"),configError:document.getElementById("configError"),connectBtn:document.getElementById("connectBtn"),settingsBtn:document.getElementById("settingsBtn"),settingsMenu:document.getElementById("settingsMenu"),changeConfigBtn:document.getElementById("changeConfigBtn"),logoutBtn:document.getElementById("logoutBtn"),micButton:document.getElementById("micButton"),statusText:document.getElementById("statusText"),chatContainer:document.getElementById("chatContainer"),emptyState:document.getElementById("emptyState"),remoteAudio:document.getElementById("remoteAudio"),loadingOverlay:document.getElementById("loadingOverlay")},t=new J,s=new q(e,t);try{yield s.init()}catch(n){console.error("Failed to initialize app:",n)}}))}},function(){return t||(0,e[n(e)[0]])((t={exports:{}}).exports,t),t.exports});export default u();
//# sourceMappingURL=main-B3Q5EmPe.js.map
