{"version":3,"file":"main-CZIIh1zL.js","sources":["../../src/utils/constants.ts","../../src/services/ApiService.ts","../../src/services/WebRTCService.ts","../../src/services/AudioService.ts","../../src/services/SessionManager.ts","../../src/components/UIController.ts","../../src/components/MicButtonController.ts","../../src/components/App.ts","../../src/services/StateManager.ts","../../src/main.ts","../../src/utils/dom.ts"],"sourcesContent":["// API Configuration\nexport const API_ENDPOINTS = {\n  WP_USER_ME: '/wp-json/wp/v2/users/me',\n  REALTIME_SESSION: '/wp-json/ai-commander/v1/realtime/session',\n  REALTIME_TOOL: '/wp-json/ai-commander/v1/realtime/tool',\n  READ_TEXT: '/wp-json/ai-commander/v1/read-text',\n} as const;\n\nexport const OPENAI_API = {\n  REALTIME_URL: 'https://api.openai.com/v1/realtime',\n  DEFAULT_MODEL: 'gpt-4o-realtime-preview-2024-12-17',\n} as const;\n\n// Audio Configuration\nexport const AUDIO_CONFIG = {\n  SAMPLE_RATE: 48000,\n  CHANNEL_COUNT: 1,\n  SAMPLE_SIZE: 16,\n  ECHO_CANCELLATION: false,\n  NOISE_SUPPRESSION: false,\n  AUTO_GAIN_CONTROL: false,\n  MAX_BITRATE: 96000,\n} as const;\n\n// UI Configuration\nexport const UI_CONFIG = {\n  ERROR_DISPLAY_DURATION: 5000,\n  MOBILE_AUDIO_CHECK_INTERVAL: 100,\n  SCROLL_BEHAVIOR: 'smooth' as const,\n} as const;\n\n// Storage Keys\nexport const STORAGE_KEYS = {\n  SITE_URL: 'inofficina_site_url',\n  USERNAME: 'inofficina_username',\n  APP_PASSWORD: 'inofficina_app_password',\n} as const;\n\n// Status Messages\nexport const STATUS_MESSAGES = {\n  disconnected: 'Premi per iniziare',\n  connecting: 'Connessione in corso...',\n  recording: 'In ascolto...',\n  processing: 'Elaborazione...',\n  speaking: 'Risposta in corso...',\n  speaking_interruptible: 'Premi per interrompere',\n  tool_wait: 'Esecuzione comando...',\n  idle: 'In attesa...',\n  error: 'Errore',\n} as const;\n\n// Error Messages\nexport const ERROR_MESSAGES = {\n  INVALID_URL: 'URL non valido. Inserisci un URL completo (es. https://www.tuaofficina.it)',\n  INVALID_CREDENTIALS: 'Credenziali non valide. Verifica nome utente e password.',\n  ACCESS_DENIED: 'Accesso negato. Verifica i permessi utente sul sito.',\n  CONNECTION_FAILED: 'Impossibile connettersi al sito WordPress',\n  SESSION_FAILED: 'Impossibile avviare la sessione',\n  TOOL_EXECUTION_FAILED: 'Tool execution failed',\n  NETWORK_ERROR: 'Network error',\n  DATA_CHANNEL_NOT_OPEN: 'Data channel not open',\n  TTS_FAILED: 'Errore nella riproduzione audio personalizzato.',\n  COMMUNICATION_ERROR: 'Errore di comunicazione',\n  UNKNOWN_ERROR: 'Errore sconosciuto',\n} as const;\n","import { API_ENDPOINTS, ERROR_MESSAGES } from '@/utils/constants';\nimport { SessionResponse, ToolExecutionRequest, ToolExecutionResponse } from '@/types';\n\nexport class ApiService {\n  constructor(\n    private siteUrl: string,\n    private bearerToken: string\n  ) {}\n\n  async testConnection(): Promise<void> {\n    const response = await fetch(`${this.siteUrl}${API_ENDPOINTS.WP_USER_ME}`, {\n      method: 'GET',\n      mode: 'cors',\n      credentials: 'omit',\n      headers: {\n        Authorization: `Basic ${this.bearerToken}`,\n      },\n    });\n\n    if (!response.ok) {\n      if (response.status === 401) {\n        throw new Error(ERROR_MESSAGES.INVALID_CREDENTIALS);\n      } else if (response.status === 403) {\n        // In multisite, status 403 might be normal\n        try {\n          const userData = await response.json();\n          if (userData && userData.id && userData.name) {\n            console.log('Authentication successful despite 403 status');\n          } else {\n            throw new Error(ERROR_MESSAGES.ACCESS_DENIED);\n          }\n        } catch (jsonError) {\n          throw new Error(ERROR_MESSAGES.ACCESS_DENIED);\n        }\n      } else {\n        throw new Error(ERROR_MESSAGES.CONNECTION_FAILED);\n      }\n    }\n  }\n\n  async createSession(): Promise<SessionResponse> {\n    const response = await fetch(`${this.siteUrl}${API_ENDPOINTS.REALTIME_SESSION}`, {\n      method: 'POST',\n      credentials: 'omit',\n      headers: {\n        'Content-Type': 'application/json',\n        Authorization: `Basic ${this.bearerToken}`,\n      },\n      body: JSON.stringify({}),\n    });\n\n    if (!response.ok) {\n      const error = await response.text();\n      throw new Error(`${ERROR_MESSAGES.SESSION_FAILED}: ${error}`);\n    }\n\n    const sessionData = await response.json();\n    if (!sessionData.client_secret?.value) {\n      throw new Error('Invalid session response');\n    }\n\n    return sessionData;\n  }\n\n  async executeTool(request: ToolExecutionRequest): Promise<ToolExecutionResponse> {\n    const response = await fetch(`${this.siteUrl}${API_ENDPOINTS.REALTIME_TOOL}`, {\n      method: 'POST',\n      credentials: 'omit',\n      headers: {\n        'Content-Type': 'application/json',\n        Authorization: `Basic ${this.bearerToken}`,\n      },\n      body: JSON.stringify(request),\n    });\n\n    const result = await response.json();\n    return result;\n  }\n\n  async getTextToSpeech(text: string, signal?: AbortSignal): Promise<Blob> {\n    const response = await fetch(`${this.siteUrl}${API_ENDPOINTS.READ_TEXT}`, {\n      method: 'POST',\n      credentials: 'omit',\n      headers: {\n        'Content-Type': 'application/json',\n        Authorization: `Basic ${this.bearerToken}`,\n      },\n      body: JSON.stringify({ text }),\n      signal: signal,\n    });\n\n    if (!response.ok) {\n      throw new Error(`TTS request failed with status ${response.status}`);\n    }\n\n    return await response.blob();\n  }\n\n  static generateBearerToken(username: string, appPassword: string): string {\n    const credentials = `${username}:${appPassword}`;\n    return btoa(credentials);\n  }\n}\n","import { OPENAI_API, AUDIO_CONFIG } from '@/utils/constants';\nimport { RealtimeEvent } from '@/types';\n\nexport interface WebRTCCallbacks {\n  onDataChannelOpen?: () => void;\n  onDataChannelMessage?: (event: MessageEvent) => void;\n  onDataChannelError?: (error: Event) => void;\n  onTrack?: (event: RTCTrackEvent) => void;\n}\n\nexport class WebRTCService {\n  private peerConnection: RTCPeerConnection | null = null;\n  private dataChannel: RTCDataChannel | null = null;\n  private localStream: MediaStream | null = null;\n\n  async startSession(\n    sessionToken: string,\n    model: string = OPENAI_API.DEFAULT_MODEL,\n    callbacks: WebRTCCallbacks = {}\n  ): Promise<void> {\n    // Create RTCPeerConnection\n    this.peerConnection = new RTCPeerConnection();\n\n    // Setup remote audio handler\n    if (callbacks.onTrack) {\n      this.peerConnection.ontrack = callbacks.onTrack;\n    }\n\n    // Increase bitrate to 96kb/s\n    this.peerConnection.getTransceivers().forEach((t) => {\n      if (t.sender.track?.kind === 'audio') {\n        const params = t.sender.getParameters();\n        params.encodings = [{ maxBitrate: AUDIO_CONFIG.MAX_BITRATE }];\n        t.sender.setParameters(params);\n      }\n    });\n\n    // Get user media\n    this.localStream = await navigator.mediaDevices.getUserMedia({\n      audio: {\n        sampleRate: AUDIO_CONFIG.SAMPLE_RATE,\n        channelCount: AUDIO_CONFIG.CHANNEL_COUNT,\n        sampleSize: AUDIO_CONFIG.SAMPLE_SIZE,\n        echoCancellation: AUDIO_CONFIG.ECHO_CANCELLATION,\n        noiseSuppression: AUDIO_CONFIG.NOISE_SUPPRESSION,\n        autoGainControl: AUDIO_CONFIG.AUTO_GAIN_CONTROL,\n      },\n    });\n\n    // Add tracks to peer connection\n    this.localStream.getTracks().forEach((track) => {\n      this.peerConnection!.addTrack(track, this.localStream!);\n    });\n\n    // Create data channel\n    this.dataChannel = this.peerConnection.createDataChannel('oai-events', {\n      ordered: true,\n    });\n\n    if (callbacks.onDataChannelOpen) {\n      this.dataChannel.onopen = callbacks.onDataChannelOpen;\n    }\n\n    if (callbacks.onDataChannelMessage) {\n      this.dataChannel.onmessage = callbacks.onDataChannelMessage;\n    }\n\n    if (callbacks.onDataChannelError) {\n      this.dataChannel.onerror = callbacks.onDataChannelError;\n    }\n\n    // SDP negotiation\n    const offer = await this.peerConnection.createOffer();\n    await this.peerConnection.setLocalDescription(offer);\n\n    const sdpResponse = await fetch(`${OPENAI_API.REALTIME_URL}?model=${model}`, {\n      method: 'POST',\n      body: offer.sdp,\n      headers: {\n        Authorization: `Bearer ${sessionToken}`,\n        'Content-Type': 'application/sdp',\n      },\n    });\n\n    if (!sdpResponse.ok) {\n      throw new Error(`SDP negotiation failed: ${sdpResponse.status}`);\n    }\n\n    const answerSdp = await sdpResponse.text();\n    await this.peerConnection.setRemoteDescription({\n      type: 'answer',\n      sdp: answerSdp,\n    });\n  }\n\n  sendEvent(event: RealtimeEvent): void {\n    if (!this.dataChannel || this.dataChannel.readyState !== 'open') {\n      throw new Error('Data channel not open');\n    }\n    this.dataChannel.send(JSON.stringify(event));\n  }\n\n  muteMicrophone(): void {\n    if (this.localStream) {\n      this.localStream.getAudioTracks().forEach((track) => {\n        track.enabled = false;\n      });\n    }\n  }\n\n  unmuteMicrophone(): void {\n    if (this.localStream) {\n      this.localStream.getAudioTracks().forEach((track) => {\n        track.enabled = true;\n      });\n    }\n  }\n\n  updateTurnDetection(mode: 'server_vad' | 'none'): void {\n    console.log(`[WebRTCService] updateTurnDetection called with mode:`, mode);\n    const event: RealtimeEvent = {\n      type: 'session.update',\n      session: {\n        turn_detection:\n          mode === 'server_vad'\n            ? {\n                type: 'server_vad',\n                threshold: 0.5,\n                prefix_padding_ms: 300,\n                silence_duration_ms: 200,\n              }\n            : null,\n      },\n    };\n    console.log('[WebRTCService] Sending session.update event:', event);\n    this.sendEvent(event);\n  }\n\n  closeSession(): void {\n    if (this.localStream) {\n      this.localStream.getTracks().forEach((track) => track.stop());\n      this.localStream = null;\n    }\n    if (this.dataChannel) {\n      this.dataChannel.close();\n      this.dataChannel = null;\n    }\n    if (this.peerConnection) {\n      this.peerConnection.close();\n      this.peerConnection = null;\n    }\n  }\n}\n","import { ERROR_MESSAGES } from '@/utils/constants';\nimport { ApiService } from './ApiService';\n\nexport class AudioService {\n  private isMobileAudioUnlocked = false;\n  private globalAudioContext: AudioContext | null = null;\n  private isPlayingCustomTts = false;\n  private currentAudioElement: HTMLAudioElement | null = null;\n  private currentAbortController: AbortController | null = null;\n\n  constructor(private apiService: ApiService) {}\n\n  /**\n   * Unlocks mobile audio playback by resuming AudioContext and performing\n   * a muted play/pause cycle on the audio element\n   */\n  unlockMobileAudio(audioElement: HTMLAudioElement): void {\n    if (this.isMobileAudioUnlocked) return;\n    this.isMobileAudioUnlocked = true;\n\n    // Ensure an AudioContext is running\n    try {\n      this.globalAudioContext =\n        this.globalAudioContext ||\n        new (window.AudioContext ||\n          (window as unknown as { webkitAudioContext: typeof AudioContext }).webkitAudioContext)();\n      if (this.globalAudioContext.state === 'suspended') {\n        this.globalAudioContext.resume();\n      }\n    } catch (error) {\n      console.warn('AudioContext initialisation failed:', error);\n    }\n\n    // Perform a muted play/pause cycle to satisfy autoplay policies\n    if (audioElement) {\n      const wasMuted = audioElement.muted;\n      audioElement.muted = true;\n\n      const playPromise = audioElement.play();\n      if (playPromise && typeof playPromise.then === 'function') {\n        playPromise\n          .then(() => {\n            audioElement.pause();\n            audioElement.currentTime = 0;\n            audioElement.muted = wasMuted;\n            console.log('[AI-Commander] Mobile audio unlocked');\n          })\n          .catch((err) => {\n            console.warn('Mobile audio unlock play() rejected:', err);\n            audioElement.muted = wasMuted;\n          });\n      } else {\n        audioElement.muted = wasMuted;\n      }\n    }\n  }\n\n  /**\n   * Plays custom TTS audio from the WordPress endpoint\n   */\n  async playCustomTtsAudio(\n    text: string,\n    audioElement: HTMLAudioElement,\n    onStart?: () => void,\n    onEnd?: () => void\n  ): Promise<void> {\n    if (!text) {\n      console.log('[AudioService] No text provided for TTS');\n      return;\n    }\n\n    console.log('[AudioService] Playing custom TTS for:', text);\n\n    try {\n      this.isPlayingCustomTts = true;\n      this.currentAudioElement = audioElement;\n\n      if (onStart) onStart();\n\n      console.log('[AudioService] Fetching TTS audio from API...');\n      \n      // Create a new AbortController for this request\n      this.currentAbortController = new AbortController();\n      \n      const audioBlob = await this.apiService.getTextToSpeech(text, this.currentAbortController.signal);\n      console.log('[AudioService] Received audio blob, size:', audioBlob.size);\n\n      // Check if playback was interrupted\n      if (!this.isPlayingCustomTts || !audioElement) {\n        return;\n      }\n\n      // Prepare audio element for playback\n      if (audioElement.dataset.objectUrl) {\n        URL.revokeObjectURL(audioElement.dataset.objectUrl);\n        delete audioElement.dataset.objectUrl;\n      }\n\n      audioElement.srcObject = null;\n      const objectUrl = URL.createObjectURL(audioBlob);\n      audioElement.dataset.objectUrl = objectUrl;\n      audioElement.src = objectUrl;\n\n      await audioElement.play();\n\n      // Wait for playback to finish\n      await new Promise<void>((resolve, reject) => {\n        const checkInterrupted = () => {\n          if (!this.isPlayingCustomTts) {\n            audioElement.pause();\n            resolve();\n          }\n        };\n\n        audioElement.onended = () => resolve();\n        audioElement.onerror = () => reject(new Error('Audio playback error'));\n\n        // Check periodically if playback was interrupted\n        const intervalId = setInterval(() => {\n          checkInterrupted();\n          if (!this.isPlayingCustomTts) {\n            clearInterval(intervalId);\n          }\n        }, 100);\n\n        // Clean up interval when promise resolves\n        const originalResolve = resolve;\n        resolve = () => {\n          clearInterval(intervalId);\n          originalResolve();\n        };\n      });\n\n      // Clean up\n      URL.revokeObjectURL(objectUrl);\n      delete audioElement.dataset.objectUrl;\n    } catch (err) {\n      // Don't throw error if it was aborted\n      if (err instanceof Error && err.name === 'AbortError') {\n        console.log('[AudioService] TTS request was aborted');\n      } else {\n        console.error('Error during custom TTS playback:', err);\n        throw new Error(ERROR_MESSAGES.TTS_FAILED);\n      }\n    } finally {\n      this.currentAbortController = null;\n      this.isPlayingCustomTts = false;\n      this.currentAudioElement = null;\n      if (onEnd) onEnd();\n    }\n  }\n\n  /**\n   * Interrupts ongoing custom TTS playback\n   */\n  interruptCustomTts(): void {\n    // Abort any pending TTS request\n    if (this.currentAbortController) {\n      this.currentAbortController.abort();\n      this.currentAbortController = null;\n      console.log('[AudioService] Aborted TTS request');\n    }\n\n    if (this.isPlayingCustomTts && this.currentAudioElement) {\n      this.isPlayingCustomTts = false;\n      this.currentAudioElement.pause();\n      this.currentAudioElement.currentTime = 0;\n\n      if (this.currentAudioElement.dataset.objectUrl) {\n        URL.revokeObjectURL(this.currentAudioElement.dataset.objectUrl);\n        delete this.currentAudioElement.dataset.objectUrl;\n      }\n\n      console.log('Custom TTS interrupted by user');\n    }\n  }\n\n  /**\n   * Cleans up audio resources\n   */\n  cleanup(audioElement: HTMLAudioElement): void {\n    this.interruptCustomTts();\n\n    if (audioElement) {\n      audioElement.pause();\n      audioElement.currentTime = 0;\n      audioElement.srcObject = null;\n      audioElement.src = '';\n\n      if (audioElement.dataset.objectUrl) {\n        URL.revokeObjectURL(audioElement.dataset.objectUrl);\n        delete audioElement.dataset.objectUrl;\n      }\n\n      audioElement.onended = null;\n    }\n  }\n\n  get isPlayingTts(): boolean {\n    return this.isPlayingCustomTts;\n  }\n}\n","import { StateManager } from './StateManager';\nimport { ApiService } from './ApiService';\nimport { WebRTCService } from './WebRTCService';\nimport { AudioService } from './AudioService';\nimport {\n  RealtimeEvent,\n  ToolCall,\n  ResponseDoneEvent,\n  TranscriptionEvent,\n  DeltaEvent,\n  ErrorEvent,\n} from '@/types';\nimport { ERROR_MESSAGES } from '@/utils/constants';\n\nexport class SessionManager {\n  private webrtcService: WebRTCService;\n  private audioService: AudioService;\n\n  constructor(\n    private stateManager: StateManager,\n    private apiService: ApiService,\n    private audioElement: HTMLAudioElement\n  ) {\n    this.webrtcService = new WebRTCService();\n    this.audioService = new AudioService(apiService);\n  }\n\n  async startSession(): Promise<void> {\n    try {\n      // Batch state updates to avoid multiple notifications\n      this.stateManager.setState({\n        status: 'connecting',\n        messages: [],\n        toolCallQueue: [],\n        currentToolCallId: null,\n      });\n\n      // Get session token from WordPress\n      const sessionData = await this.apiService.createSession();\n      this.stateManager.setSessionData(\n        sessionData.client_secret.value,\n        sessionData.modalities || ['text', 'audio']\n      );\n\n      console.log('Session modalities:', sessionData.modalities);\n      console.log('Custom TTS enabled:', !sessionData.modalities?.includes('audio'));\n\n      // Start WebRTC session\n      await this.webrtcService.startSession(sessionData.client_secret.value, sessionData.model, {\n        onDataChannelOpen: () => {\n          this.stateManager.updateStatus('recording');\n        },\n        onDataChannelMessage: (event) => this.handleServerEvent(event),\n        onDataChannelError: (error) => {\n          console.error('Data channel error:', error);\n          this.handleError(ERROR_MESSAGES.COMMUNICATION_ERROR);\n        },\n        onTrack: (event) => {\n          if (this.audioElement && event.streams && event.streams[0]) {\n            this.audioElement.srcObject = event.streams[0];\n            this.audioElement.play().catch((e) => console.error('Audio play error:', e));\n          }\n        },\n      });\n    } catch (error) {\n      console.error('Session start error:', error);\n      this.handleError((error as Error).message || ERROR_MESSAGES.SESSION_FAILED);\n      this.stopSession();\n    }\n  }\n\n  stopSession(): void {\n    // Interrupt any ongoing custom TTS playback\n    if (this.stateManager.getState().isPlayingCustomTts) {\n      this.audioService.interruptCustomTts();\n    }\n\n    this.webrtcService.closeSession();\n    this.audioService.cleanup(this.audioElement);\n    this.stateManager.updateStatus('disconnected');\n    this.stateManager.updateTranscript('');\n  }\n\n  setVadEnabled(enabled: boolean): void {\n    console.log(`[SessionManager] setVadEnabled called with:`, enabled);\n    try {\n      this.webrtcService.updateTurnDetection(enabled ? 'server_vad' : 'none');\n      console.log(`[SessionManager] VAD ${enabled ? 'enabled' : 'disabled'} - session update sent`);\n      \n      // When re-enabling VAD after press-to-talk, commit the audio buffer and create response\n      if (enabled) {\n        console.log('[SessionManager] Committing audio buffer after press-to-talk');\n        this.webrtcService.sendEvent({\n          type: 'input_audio_buffer.commit'\n        });\n        \n        // Create a response after committing the buffer\n        console.log('[SessionManager] Creating response after press-to-talk');\n        this.webrtcService.sendEvent({\n          type: 'response.create'\n        });\n      }\n    } catch (error) {\n      console.error('[SessionManager] Failed to update VAD:', error);\n    }\n  }\n\n  private async handleServerEvent(event: MessageEvent): Promise<void> {\n    try {\n      const data: RealtimeEvent = JSON.parse(event.data);\n      console.log('Server event:', data.type, data);\n\n      const state = this.stateManager.getState();\n\n      switch (data.type) {\n        case 'input_audio_buffer.speech_started':\n          this.webrtcService.unmuteMicrophone();\n          this.stateManager.updateStatus('recording');\n          break;\n\n        case 'input_audio_buffer.speech_stopped':\n          this.stateManager.updateStatus('processing');\n          break;\n\n        case 'conversation.item.input_audio_transcription.completed':\n          this.stateManager.addMessage({\n            type: 'user',\n            content: (data as TranscriptionEvent).transcript,\n          });\n          break;\n\n        case 'response.created':\n          this.stateManager.updateTranscript('');\n          break;\n\n        case 'response.audio_transcript.delta':\n        case 'response.text.delta':\n          this.stateManager.appendTranscript((data as DeltaEvent).delta || '');\n          break;\n\n        case 'response.audio.delta':\n          if (!state.isCustomTtsEnabled) {\n            this.stateManager.updateStatus('speaking');\n          }\n          break;\n\n        case 'response.function_call_arguments.delta':\n          // Only update to tool_wait if not already in that state\n          if (state.status !== 'tool_wait') {\n            this.stateManager.updateStatus('tool_wait');\n          }\n          break;\n\n        case 'response.done':\n          await this.handleResponseDone(data as ResponseDoneEvent);\n          break;\n\n        case 'output_audio_buffer.stopped':\n          if (!state.isCustomTtsEnabled) {\n            this.stateManager.updateStatus('idle');\n          }\n          break;\n\n        case 'error':\n          console.error('API Error:', data);\n          this.handleError((data as ErrorEvent).message || ERROR_MESSAGES.UNKNOWN_ERROR);\n          break;\n      }\n    } catch (error) {\n      console.error('Error parsing server event:', error);\n    }\n  }\n\n  private async handleResponseDone(data: ResponseDoneEvent): Promise<void> {\n    // Clear typing indicator\n    this.stateManager.updateTranscript('');\n\n    if (data.response.status === 'failed') {\n      this.stateManager.updateStatus('error');\n      return;\n    }\n\n    const responseOutput = data.response?.output?.[0]?.content?.[0];\n    const responseText = responseOutput?.text || responseOutput?.transcript;\n\n    if (responseText) {\n      this.stateManager.addMessage({ type: 'assistant', content: responseText });\n    }\n\n    // If custom TTS is enabled, synthesize and play audio now\n    const state = this.stateManager.getState();\n    if (state.isCustomTtsEnabled && responseText) {\n      await this.playCustomTts(responseText);\n    }\n\n    // Handle function calls\n    if (data.response.output) {\n      data.response.output.forEach((outputItem) => {\n        if (\n          outputItem.type === 'function_call' &&\n          outputItem.call_id &&\n          outputItem.name &&\n          outputItem.arguments\n        ) {\n          this.stateManager.queueToolCall({\n            name: outputItem.name,\n            arguments: outputItem.arguments,\n            call_id: outputItem.call_id,\n          });\n        }\n      });\n    }\n\n    // Process tool calls if any\n    const toolCall = this.stateManager.dequeueToolCall();\n    if (toolCall) {\n      await this.processToolCall(toolCall);\n    }\n  }\n\n  private async playCustomTts(text: string): Promise<void> {\n    console.log('[SessionManager] Starting custom TTS for text:', text);\n    try {\n      await this.audioService.playCustomTtsAudio(\n        text,\n        this.audioElement,\n        () => {\n          console.log('[SessionManager] Custom TTS started');\n          this.stateManager.setPlayingCustomTts(true);\n          this.stateManager.updateStatus('speaking');\n          this.webrtcService.muteMicrophone();\n        },\n        () => {\n          console.log('[SessionManager] Custom TTS ended');\n          const state = this.stateManager.getState();\n          if (state.status !== 'disconnected') {\n            this.stateManager.setPlayingCustomTts(false);\n            this.webrtcService.unmuteMicrophone();\n            this.stateManager.updateStatus('recording');\n          }\n        }\n      );\n    } catch (error) {\n      console.error('Custom TTS error:', error);\n      if (this.stateManager.getState().status !== 'disconnected') {\n        this.handleError(ERROR_MESSAGES.TTS_FAILED);\n      }\n    }\n  }\n\n  private async processToolCall(toolCall: ToolCall): Promise<void> {\n    // Status is already set to 'tool_wait' when receiving function_call_arguments.delta\n    try {\n      const result = await this.apiService.executeTool({\n        tool_name: toolCall.name,\n        arguments: toolCall.arguments,\n      });\n\n      if (!result.error) {\n        this.sendFunctionResult(toolCall.call_id, result);\n      } else {\n        this.sendFunctionResult(toolCall.call_id, {\n          error: true,\n          message: result.message || ERROR_MESSAGES.TOOL_EXECUTION_FAILED,\n        });\n      }\n    } catch (error) {\n      this.sendFunctionResult(toolCall.call_id, {\n        error: true,\n        message: ERROR_MESSAGES.NETWORK_ERROR,\n      });\n    }\n\n    // Process next tool call if any\n    const nextToolCall = this.stateManager.dequeueToolCall();\n    if (nextToolCall) {\n      await this.processToolCall(nextToolCall);\n    }\n  }\n\n  private sendFunctionResult(callId: string, result: unknown): void {\n    try {\n      // Send function result\n      this.webrtcService.sendEvent({\n        type: 'conversation.item.create',\n        item: {\n          type: 'function_call_output',\n          call_id: callId,\n          output: JSON.stringify(result),\n        },\n      });\n\n      // Request response\n      this.webrtcService.sendEvent({\n        type: 'response.create',\n      });\n    } catch (error) {\n      this.handleError(ERROR_MESSAGES.DATA_CHANNEL_NOT_OPEN);\n    }\n  }\n\n  interruptTts(): void {\n    if (this.stateManager.getState().isPlayingCustomTts) {\n      this.audioService.interruptCustomTts();\n    } else {\n      this.stopSession();\n    }\n  }\n\n  private handleError(message: string): void {\n    console.error('Error:', message);\n    this.stateManager.updateStatus('error');\n  }\n}\n","import { UIElements, Message } from '@/types';\nimport { UI_CONFIG } from '@/utils/constants';\n\nexport class UIController {\n  private typingMessageDiv: HTMLDivElement | null = null;\n\n  constructor(private elements: UIElements) {}\n\n  showConfigScreen(): void {\n    this.elements.configScreen.style.display = 'flex';\n    this.elements.mainApp.classList.remove('active');\n  }\n\n  showMainApp(): void {\n    this.elements.configScreen.style.display = 'none';\n    this.elements.mainApp.classList.add('active');\n  }\n\n  showError(message: string): void {\n    this.elements.configError.textContent = message;\n    this.elements.configError.style.display = 'block';\n    setTimeout(() => {\n      this.elements.configError.style.display = 'none';\n    }, UI_CONFIG.ERROR_DISPLAY_DURATION);\n  }\n\n  showLoading(show: boolean): void {\n    this.elements.loadingOverlay.style.display = show ? 'flex' : 'none';\n  }\n\n  toggleSettingsMenu(): void {\n    this.elements.settingsMenu.classList.toggle('active');\n  }\n\n  hideSettingsMenu(): void {\n    this.elements.settingsMenu.classList.remove('active');\n  }\n\n  clearMessages(): void {\n    this.elements.chatContainer.innerHTML = '';\n    this.elements.chatContainer.appendChild(this.elements.emptyState);\n  }\n\n  addMessage(message: Message): void {\n    if (this.elements.emptyState.parentNode) {\n      this.elements.emptyState.remove();\n    }\n\n    const messageDiv = document.createElement('div');\n    messageDiv.className = `chat-message ${message.type}`;\n\n    const bubbleDiv = document.createElement('div');\n    bubbleDiv.className = 'message-bubble';\n    bubbleDiv.textContent = message.content;\n\n    messageDiv.appendChild(bubbleDiv);\n    this.elements.chatContainer.appendChild(messageDiv);\n\n    // Scroll to bottom\n    this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;\n  }\n\n  showTypingIndicator(): void {\n    if (this.elements.emptyState.parentNode) {\n      this.elements.emptyState.remove();\n    }\n\n    this.typingMessageDiv = document.createElement('div');\n    this.typingMessageDiv.className = 'chat-message assistant';\n    this.typingMessageDiv.id = 'typingMessage';\n\n    const bubbleDiv = document.createElement('div');\n    bubbleDiv.className = 'message-bubble typing';\n    bubbleDiv.innerHTML = `\n      <span class=\"typing-dot\"></span>\n      <span class=\"typing-dot\"></span>\n      <span class=\"typing-dot\"></span>\n    `;\n\n    this.typingMessageDiv.appendChild(bubbleDiv);\n    this.elements.chatContainer.appendChild(this.typingMessageDiv);\n\n    // Scroll to bottom\n    this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;\n  }\n\n  updateTypingMessage(text: string): void {\n    if (this.typingMessageDiv && text) {\n      const bubble = this.typingMessageDiv.querySelector('.message-bubble');\n      if (bubble) {\n        bubble.className = 'message-bubble';\n        bubble.textContent = text;\n\n        // Scroll to bottom\n        this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;\n      }\n    }\n  }\n\n  hideTypingIndicator(): void {\n    if (this.typingMessageDiv) {\n      this.typingMessageDiv.remove();\n      this.typingMessageDiv = null;\n    }\n  }\n\n  hasTypingIndicator(): boolean {\n    return this.typingMessageDiv !== null;\n  }\n\n  populateConfigForm(siteUrl: string, username: string): void {\n    this.elements.siteUrlInput.value = siteUrl;\n    this.elements.usernameInput.value = username;\n    this.elements.appPasswordInput.value = ''; // Don't populate password for security\n  }\n\n  clearConfigForm(): void {\n    this.elements.siteUrlInput.value = '';\n    this.elements.usernameInput.value = '';\n    this.elements.appPasswordInput.value = '';\n  }\n\n  disableConnectButton(disabled: boolean, text?: string): void {\n    this.elements.connectBtn.disabled = disabled;\n    if (text) {\n      this.elements.connectBtn.textContent = text;\n    }\n  }\n}\n","import { AppStatus } from '@/types';\nimport { STATUS_MESSAGES } from '@/utils/constants';\n\nexport interface MicButtonCallbacks {\n  onStartRecording: () => void;\n  onStopRecording: () => void;\n  onInterruptTts: () => void;\n  onPressAndHoldStart?: () => void;\n  onPressAndHoldEnd?: () => void;\n}\n\nexport class MicButtonController {\n  private currentState: AppStatus = 'disconnected';\n  private callbacks: MicButtonCallbacks;\n  private buttonElement: HTMLButtonElement;\n  private statusElement: HTMLElement;\n  private pressTimer: number | null = null;\n  private isPressAndHold: boolean = false;\n  private pressStartTime: number = 0;\n  private readonly PRESS_HOLD_DELAY = 300; // milliseconds to detect press-and-hold\n  private readonly MIN_CLICK_TIME = 50; // minimum time to consider it a click\n\n  constructor(\n    buttonElement: HTMLButtonElement,\n    statusElement: HTMLElement,\n    callbacks: MicButtonCallbacks\n  ) {\n    this.buttonElement = buttonElement;\n    this.statusElement = statusElement;\n    this.callbacks = callbacks;\n    this.setupEventListeners();\n  }\n\n  private setupEventListeners(): void {\n    // Click event for simple clicks\n    this.buttonElement.addEventListener('click', () => {\n      // Only handle click if it's not from a press-and-hold\n      if (!this.isPressAndHold && this.pressStartTime === 0) {\n        this.handleClick();\n      }\n    });\n\n    // Mouse events\n    this.buttonElement.addEventListener('mousedown', (e) => this.handlePressStart(e));\n    this.buttonElement.addEventListener('mouseup', (e) => this.handlePressEnd(e));\n    this.buttonElement.addEventListener('mouseleave', (e) => this.handlePressCancel(e));\n\n    // Touch events\n    this.buttonElement.addEventListener('touchstart', (e) => this.handlePressStart(e), {\n      passive: false,\n    });\n    this.buttonElement.addEventListener('touchend', (e) => this.handlePressEnd(e), {\n      passive: false,\n    });\n    this.buttonElement.addEventListener('touchcancel', (e) => this.handlePressCancel(e));\n  }\n\n  private handlePressStart(e: Event): void {\n    console.log('[MicButton] Press start event:', e.type, 'Current state:', this.currentState);\n    \n    // Only prevent default for touch events to avoid scroll\n    if (e.type === 'touchstart') {\n      e.preventDefault();\n    }\n\n    this.pressStartTime = Date.now();\n    this.isPressAndHold = false;\n\n    // Only start press-and-hold timer in recording state\n    if (this.currentState === 'recording') {\n      console.log('[MicButton] Starting press-and-hold timer (300ms)');\n      // Start timer for press-and-hold detection\n      this.pressTimer = window.setTimeout(() => {\n        this.isPressAndHold = true;\n        console.log('[MicButton] Press-and-hold ACTIVATED');\n        \n        // Add visual feedback\n        this.buttonElement.classList.add('press-and-hold');\n        \n        if (this.callbacks.onPressAndHoldStart) {\n          console.log('[MicButton] Calling onPressAndHoldStart callback');\n          this.callbacks.onPressAndHoldStart();\n        }\n      }, this.PRESS_HOLD_DELAY);\n    } else {\n      console.log('[MicButton] Not in recording state, skipping press-and-hold');\n    }\n  }\n\n  private handlePressEnd(e: Event): void {\n    const pressDuration = Date.now() - this.pressStartTime;\n    console.log('[MicButton] Press end event:', e.type, 'Duration:', pressDuration, 'ms', 'isPressAndHold:', this.isPressAndHold);\n    \n    if (e.type === 'touchend') {\n      e.preventDefault();\n    }\n\n    // Clear the timer\n    if (this.pressTimer) {\n      clearTimeout(this.pressTimer);\n      this.pressTimer = null;\n    }\n\n    // If press-and-hold was active, end it\n    if (this.isPressAndHold && this.callbacks.onPressAndHoldEnd) {\n      console.log('[MicButton] Ending press-and-hold, calling onPressAndHoldEnd callback');\n      \n      // Remove visual feedback\n      this.buttonElement.classList.remove('press-and-hold');\n      \n      this.callbacks.onPressAndHoldEnd();\n      // Reset immediately\n      this.isPressAndHold = false;\n    } else if (\n      this.pressStartTime > 0 &&\n      pressDuration >= this.MIN_CLICK_TIME &&\n      pressDuration < this.PRESS_HOLD_DELAY\n    ) {\n      // Normal click: between MIN_CLICK_TIME and PRESS_HOLD_DELAY\n      console.log('[MicButton] Normal click detected, calling handleClick()');\n      this.handleClick();\n    }\n\n    // Reset for next press\n    this.isPressAndHold = false;\n    this.pressStartTime = 0;\n  }\n\n  private handlePressCancel(_e: Event): void {\n    console.log('[MicButton] Press cancelled');\n    \n    // Clear timer and reset state if user moves away\n    if (this.pressTimer) {\n      clearTimeout(this.pressTimer);\n      this.pressTimer = null;\n    }\n\n    if (this.isPressAndHold && this.callbacks.onPressAndHoldEnd) {\n      console.log('[MicButton] Press-and-hold cancelled, calling onPressAndHoldEnd');\n      \n      // Remove visual feedback\n      this.buttonElement.classList.remove('press-and-hold');\n      \n      this.callbacks.onPressAndHoldEnd();\n    }\n\n    this.isPressAndHold = false;\n    this.pressStartTime = 0;\n  }\n\n  handleClick(): void {\n    switch (this.currentState) {\n      case 'disconnected':\n      case 'error':\n        this.callbacks.onStartRecording();\n        break;\n\n      case 'speaking':\n        this.callbacks.onInterruptTts();\n        break;\n\n      case 'recording':\n      case 'processing':\n      case 'tool_wait':\n      case 'idle':\n        this.callbacks.onStopRecording();\n        break;\n\n      case 'connecting':\n        // Do nothing while connecting\n        break;\n\n      default:\n        console.warn('Unknown mic button state:', this.currentState);\n    }\n  }\n\n  setState(newState: AppStatus, options: { message?: string } = {}): void {\n    console.log(`Mic button: ${this.currentState} → ${newState}`);\n    this.currentState = newState;\n    this.updateUI(newState, options);\n  }\n\n  private updateUI(state: AppStatus, options: { message?: string } = {}): void {\n    this.buttonElement.className = 'mic-button';\n    this.buttonElement.innerHTML = '';\n    this.buttonElement.disabled = false;\n\n    switch (state) {\n      case 'disconnected':\n        this.statusElement.textContent = STATUS_MESSAGES.disconnected;\n        this.statusElement.className = 'status-text';\n        this.buttonElement.innerHTML = this.getMicIcon();\n        break;\n\n      case 'connecting':\n        this.statusElement.textContent = STATUS_MESSAGES.connecting;\n        this.statusElement.className = 'status-text';\n        this.buttonElement.innerHTML = '<div class=\"spinner\"></div>';\n        this.buttonElement.disabled = true;\n        break;\n\n      case 'recording':\n        this.statusElement.textContent = STATUS_MESSAGES.recording;\n        this.statusElement.className = 'status-text';\n        this.buttonElement.classList.add('recording');\n        this.buttonElement.innerHTML = this.getSoundWaveIcon();\n        break;\n\n      case 'processing':\n        this.statusElement.textContent = STATUS_MESSAGES.processing;\n        this.statusElement.className = 'status-text';\n        this.buttonElement.innerHTML = '<div class=\"spinner\"></div>';\n        break;\n\n      case 'speaking':\n        this.statusElement.textContent = STATUS_MESSAGES.speaking_interruptible;\n        this.statusElement.className = 'status-text';\n        this.buttonElement.disabled = false;\n        this.buttonElement.innerHTML = this.getStopIcon();\n        break;\n\n      case 'tool_wait':\n        this.statusElement.textContent = STATUS_MESSAGES.tool_wait;\n        this.statusElement.className = 'status-text';\n        this.buttonElement.innerHTML = '<div class=\"spinner\"></div>';\n        break;\n\n      case 'idle':\n        this.statusElement.textContent = STATUS_MESSAGES.idle;\n        this.statusElement.className = 'status-text';\n        this.buttonElement.innerHTML = this.getStopIcon();\n        break;\n\n      case 'error':\n        this.statusElement.textContent = options.message || STATUS_MESSAGES.error;\n        this.statusElement.className = 'status-text error';\n        this.buttonElement.innerHTML = this.getMicIcon();\n        break;\n    }\n  }\n\n  private getMicIcon(): string {\n    return `\n      <svg viewBox=\"0 0 24 24\" fill=\"currentColor\">\n        <path d=\"M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z\"/>\n        <path d=\"M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z\"/>\n      </svg>\n    `;\n  }\n\n  private getStopIcon(): string {\n    return `\n      <svg viewBox=\"0 0 24 24\" fill=\"currentColor\">\n        <rect x=\"6\" y=\"6\" width=\"12\" height=\"12\" rx=\"2\"/>\n      </svg>\n    `;\n  }\n\n  private getSoundWaveIcon(): string {\n    return `\n      <div class=\"sound-wave\">\n        <span class=\"sound-bar\"></span>\n        <span class=\"sound-bar\"></span>\n        <span class=\"sound-bar\"></span>\n        <span class=\"sound-bar\"></span>\n        <span class=\"sound-bar\"></span>\n      </div>\n    `;\n  }\n}\n","import { UIElements, AppState } from '@/types';\nimport { StateManager } from '@/services/StateManager';\nimport { ApiService } from '@/services/ApiService';\nimport { SessionManager } from '@/services/SessionManager';\nimport { AudioService } from '@/services/AudioService';\nimport { UIController } from './UIController';\nimport { MicButtonController } from './MicButtonController';\nimport { ERROR_MESSAGES, STORAGE_KEYS } from '@/utils/constants';\n\nexport class App {\n  private uiController: UIController;\n  private micController: MicButtonController;\n  private sessionManager: SessionManager | null = null;\n  // @ts-expect-error - Used in handleConfigSubmit\n  private apiService: ApiService | null = null;\n  private audioService: AudioService | null = null;\n  private lastMessageCount = 0;\n\n  constructor(\n    private elements: UIElements,\n    private stateManager: StateManager\n  ) {\n    this.uiController = new UIController(elements);\n    this.micController = new MicButtonController(elements.micButton, elements.statusText, {\n      onStartRecording: () => this.startRecordingSession(),\n      onStopRecording: () => this.stopRecordingSession(),\n      onInterruptTts: () => this.interruptTts(),\n      onPressAndHoldStart: () => this.handlePressAndHoldStart(),\n      onPressAndHoldEnd: () => this.handlePressAndHoldEnd(),\n    });\n  }\n\n  async init(): Promise<void> {\n    // Set up event listeners first\n    this.setupEventListeners();\n\n    // Subscribe to state changes\n    this.stateManager.subscribe((state) => this.onStateChange(state));\n\n    // Check if we have saved credentials\n    const state = this.stateManager.getState();\n    if (state.siteUrl && this.generateBearerToken()) {\n      this.elements.siteUrlInput.value = state.siteUrl;\n      this.elements.usernameInput.value = state.username;\n\n      // Just show the main app without testing connection\n      // Services will be initialized on first mic button click\n      this.uiController.showMainApp();\n    } else {\n      this.uiController.showConfigScreen();\n    }\n  }\n\n  private setupEventListeners(): void {\n    // Config form submission\n    this.elements.configForm.addEventListener('submit', (e) => this.handleConfigSubmit(e));\n\n    // Settings menu\n    this.elements.settingsBtn.addEventListener('click', (e) => {\n      e.stopPropagation();\n      this.uiController.toggleSettingsMenu();\n    });\n\n    // Change configuration\n    this.elements.changeConfigBtn.addEventListener('click', () => {\n      this.uiController.hideSettingsMenu();\n      this.uiController.showConfigScreen();\n      this.uiController.populateConfigForm(\n        this.stateManager.getState().siteUrl,\n        this.stateManager.getState().username\n      );\n    });\n\n    // Logout\n    this.elements.logoutBtn.addEventListener('click', () => this.handleLogout());\n\n    // Unlock mobile audio on first mic button click\n    this.elements.micButton.addEventListener(\n      'click',\n      () => {\n        if (this.audioService) {\n          this.audioService.unlockMobileAudio(this.elements.remoteAudio);\n        }\n      },\n      { once: true }\n    );\n\n    // Close settings menu when clicking outside\n    document.addEventListener('click', (e) => {\n      if (\n        !this.elements.settingsBtn.contains(e.target as Node) &&\n        !this.elements.settingsMenu.contains(e.target as Node)\n      ) {\n        this.uiController.hideSettingsMenu();\n      }\n    });\n  }\n\n  private onStateChange(state: AppState): void {\n    // Update mic button state\n    this.micController.setState(state.status);\n\n    // Update UI based on state changes\n    if (state.currentTranscript) {\n      if (!this.uiController.hasTypingIndicator()) {\n        this.uiController.showTypingIndicator();\n      }\n      this.uiController.updateTypingMessage(state.currentTranscript);\n    } else {\n      // Hide typing indicator when transcript is cleared\n      this.uiController.hideTypingIndicator();\n    }\n\n    // Handle messages\n    if (state.messages.length !== this.lastMessageCount) {\n      if (state.messages.length === 0) {\n        // Messages were cleared\n        this.uiController.clearMessages();\n        this.lastMessageCount = 0;\n      } else if (state.messages.length > this.lastMessageCount) {\n        // New messages were added\n        const newMessages = state.messages.slice(this.lastMessageCount);\n        newMessages.forEach((msg) => this.uiController.addMessage(msg));\n        this.lastMessageCount = state.messages.length;\n      } else {\n        // Messages were removed (shouldn't happen normally)\n        // Rebuild the entire message list\n        this.uiController.clearMessages();\n        state.messages.forEach((msg) => this.uiController.addMessage(msg));\n        this.lastMessageCount = state.messages.length;\n      }\n    }\n  }\n\n  private generateBearerToken(): boolean {\n    const storedPassword = localStorage.getItem(STORAGE_KEYS.APP_PASSWORD);\n    const state = this.stateManager.getState();\n\n    if (state.username && storedPassword) {\n      const bearerToken = ApiService.generateBearerToken(state.username, storedPassword);\n      this.stateManager.setState({ bearerToken });\n      return true;\n    }\n    return false;\n  }\n\n  private async handleConfigSubmit(e: Event): Promise<void> {\n    e.preventDefault();\n\n    const url = this.elements.siteUrlInput.value.trim();\n    const username = this.elements.usernameInput.value.trim();\n    const appPassword = this.elements.appPasswordInput.value.trim();\n\n    if (!url || !username || !appPassword) return;\n\n    // Validate URL\n    try {\n      const validUrl = new URL(url);\n      if (!validUrl.protocol.startsWith('http')) {\n        throw new Error('URL deve iniziare con http:// o https://');\n      }\n    } catch (error) {\n      this.uiController.showError(ERROR_MESSAGES.INVALID_URL);\n      return;\n    }\n\n    // Generate bearer token\n    const bearerToken = ApiService.generateBearerToken(username, appPassword);\n\n    // Test connection\n    this.uiController.disableConnectButton(true, 'Connessione...');\n\n    try {\n      const apiService = new ApiService(url, bearerToken);\n      await apiService.testConnection();\n\n      // Save configuration\n      const cleanUrl = url.replace(/\\/$/, ''); // Remove trailing slash\n      this.stateManager.setSiteConfig(cleanUrl, username, bearerToken);\n      localStorage.setItem(STORAGE_KEYS.APP_PASSWORD, appPassword);\n\n      // Initialize services\n      await this.initializeServices(cleanUrl, bearerToken);\n\n      this.uiController.showMainApp();\n    } catch (error) {\n      this.uiController.showError(\n        (error as Error).message || 'Impossibile connettersi. Verifica i dati e riprova.'\n      );\n    } finally {\n      this.uiController.disableConnectButton(false, 'Connetti');\n    }\n  }\n\n  private handleLogout(): void {\n    if (confirm('Vuoi disconnetterti e cancellare le credenziali salvate?')) {\n      this.stateManager.clearSiteConfig();\n      this.uiController.clearConfigForm();\n      this.uiController.hideSettingsMenu();\n      this.uiController.showConfigScreen();\n      this.stopRecordingSession();\n    }\n  }\n\n  private async startRecordingSession(): Promise<void> {\n    // Initialize services if not already done\n    if (!this.sessionManager) {\n      const state = this.stateManager.getState();\n      if (!state.siteUrl || !state.bearerToken) {\n        this.uiController.showError('Credenziali non trovate. Accedi nuovamente.');\n        this.uiController.showConfigScreen();\n        return;\n      }\n\n      try {\n        this.uiController.showLoading(true);\n        await this.initializeServices(state.siteUrl, state.bearerToken);\n      } catch (error) {\n        console.error('Failed to initialize services:', error);\n        this.uiController.showLoading(false);\n        this.uiController.showError('Sessione scaduta. Accedi nuovamente.');\n        this.uiController.showConfigScreen();\n        return;\n      }\n    }\n\n    // Show loading while starting session\n    this.uiController.showLoading(true);\n\n    try {\n      await this.sessionManager!.startSession();\n    } catch (error) {\n      console.error('Failed to start session:', error);\n    } finally {\n      this.uiController.showLoading(false);\n    }\n  }\n\n  private stopRecordingSession(): void {\n    if (this.sessionManager) {\n      this.sessionManager.stopSession();\n    }\n    this.uiController.hideTypingIndicator();\n  }\n\n  private interruptTts(): void {\n    if (this.sessionManager) {\n      this.sessionManager.interruptTts();\n    }\n  }\n\n  private handlePressAndHoldStart(): void {\n    console.log('[App] handlePressAndHoldStart called, sessionManager exists:', !!this.sessionManager);\n    if (this.sessionManager) {\n      this.sessionManager.setVadEnabled(false);\n    } else {\n      console.log('[App] No sessionManager available');\n    }\n  }\n\n  private handlePressAndHoldEnd(): void {\n    console.log('[App] handlePressAndHoldEnd called, sessionManager exists:', !!this.sessionManager);\n    if (this.sessionManager) {\n      this.sessionManager.setVadEnabled(true);\n    } else {\n      console.log('[App] No sessionManager available');\n    }\n  }\n\n  private async initializeServices(siteUrl: string, bearerToken: string): Promise<void> {\n    const apiService = new ApiService(siteUrl, bearerToken);\n\n    // Only test connection when actually needed\n    // This will throw if credentials are invalid\n    await apiService.testConnection();\n\n    this.apiService = apiService;\n    this.audioService = new AudioService(apiService);\n    this.sessionManager = new SessionManager(\n      this.stateManager,\n      apiService,\n      this.elements.remoteAudio\n    );\n  }\n}\n","import { AppState, AppStatus, Message, ToolCall } from '@/types';\nimport { STORAGE_KEYS } from '@/utils/constants';\n\nexport class StateManager {\n  private state: AppState;\n  private listeners: Array<(state: AppState) => void> = [];\n\n  constructor() {\n    this.state = {\n      siteUrl: localStorage.getItem(STORAGE_KEYS.SITE_URL) || '',\n      username: localStorage.getItem(STORAGE_KEYS.USERNAME) || '',\n      bearerToken: null,\n      sessionToken: null,\n      status: 'disconnected',\n      messages: [],\n      currentTranscript: '',\n      peerConnection: null,\n      dataChannel: null,\n      localStream: null,\n      toolCallQueue: [],\n      currentToolCallId: null,\n      isCustomTtsEnabled: false,\n      sessionModalities: [],\n      isPlayingCustomTts: false,\n    };\n  }\n\n  getState(): AppState {\n    return this.state;\n  }\n\n  setState(updates: Partial<AppState>): void {\n    this.state = { ...this.state, ...updates };\n    this.notifyListeners();\n  }\n\n  updateStatus(status: AppStatus): void {\n    this.setState({ status });\n  }\n\n  addMessage(message: Message): void {\n    this.setState({ messages: [...this.state.messages, message] });\n  }\n\n  clearMessages(): void {\n    this.setState({ messages: [] });\n  }\n\n  setSiteConfig(siteUrl: string, username: string, bearerToken: string): void {\n    this.setState({ siteUrl, username, bearerToken });\n    localStorage.setItem(STORAGE_KEYS.SITE_URL, siteUrl);\n    localStorage.setItem(STORAGE_KEYS.USERNAME, username);\n  }\n\n  clearSiteConfig(): void {\n    this.setState({ siteUrl: '', username: '', bearerToken: null });\n    localStorage.removeItem(STORAGE_KEYS.SITE_URL);\n    localStorage.removeItem(STORAGE_KEYS.USERNAME);\n    localStorage.removeItem(STORAGE_KEYS.APP_PASSWORD);\n  }\n\n  setSessionData(sessionToken: string, modalities: string[]): void {\n    const isCustomTtsEnabled = !modalities.includes('audio');\n    this.setState({ sessionToken, sessionModalities: modalities, isCustomTtsEnabled });\n  }\n\n  updateTranscript(transcript: string): void {\n    this.setState({ currentTranscript: transcript });\n  }\n\n  appendTranscript(delta: string): void {\n    this.setState({ currentTranscript: this.state.currentTranscript + delta });\n  }\n\n  queueToolCall(toolCall: ToolCall): void {\n    this.setState({ toolCallQueue: [...this.state.toolCallQueue, toolCall] });\n  }\n\n  dequeueToolCall(): ToolCall | undefined {\n    const [toolCall, ...rest] = this.state.toolCallQueue;\n    this.setState({ toolCallQueue: rest, currentToolCallId: toolCall?.call_id || null });\n    return toolCall;\n  }\n\n  setPlayingCustomTts(isPlaying: boolean): void {\n    this.setState({ isPlayingCustomTts: isPlaying });\n  }\n\n  subscribe(listener: (state: AppState) => void): () => void {\n    this.listeners.push(listener);\n    return () => {\n      this.listeners = this.listeners.filter((l) => l !== listener);\n    };\n  }\n\n  private notifyListeners(): void {\n    this.listeners.forEach((listener) => listener(this.state));\n  }\n}\n","import { App } from './components/App';\nimport { StateManager } from './services/StateManager';\nimport { initializeElements } from './utils/dom';\nimport './styles/main.css';\n\n// Initialize the application when DOM is ready\ndocument.addEventListener('DOMContentLoaded', async () => {\n  const elements = initializeElements();\n  const stateManager = new StateManager();\n  const app = new App(elements, stateManager);\n\n  try {\n    await app.init();\n  } catch (error) {\n    console.error('Failed to initialize app:', error);\n  }\n});\n","import { UIElements } from '@/types';\n\nexport function initializeElements(): UIElements {\n  return {\n    configScreen: document.getElementById('configScreen') as HTMLElement,\n    mainApp: document.getElementById('mainApp') as HTMLElement,\n    configForm: document.getElementById('configForm') as HTMLFormElement,\n    siteUrlInput: document.getElementById('siteUrl') as HTMLInputElement,\n    usernameInput: document.getElementById('username') as HTMLInputElement,\n    appPasswordInput: document.getElementById('appPassword') as HTMLInputElement,\n    configError: document.getElementById('configError') as HTMLElement,\n    connectBtn: document.getElementById('connectBtn') as HTMLButtonElement,\n    settingsBtn: document.getElementById('settingsBtn') as HTMLButtonElement,\n    settingsMenu: document.getElementById('settingsMenu') as HTMLElement,\n    changeConfigBtn: document.getElementById('changeConfigBtn') as HTMLElement,\n    logoutBtn: document.getElementById('logoutBtn') as HTMLElement,\n    micButton: document.getElementById('micButton') as HTMLButtonElement,\n    statusText: document.getElementById('statusText') as HTMLElement,\n    chatContainer: document.getElementById('chatContainer') as HTMLElement,\n    emptyState: document.getElementById('emptyState') as HTMLElement,\n    remoteAudio: document.getElementById('remoteAudio') as HTMLAudioElement,\n    loadingOverlay: document.getElementById('loadingOverlay') as HTMLElement,\n  };\n}\n"],"names":["API_ENDPOINTS","OPENAI_API","AUDIO_CONFIG","UI_CONFIG","STORAGE_KEYS","STATUS_MESSAGES","ERROR_MESSAGES","ApiService","constructor","siteUrl","bearerToken","this","testConnection","__async","response","fetch","method","mode","credentials","headers","Authorization","ok","status","Error","userData","json","id","name","console","log","jsonError","createSession","body","JSON","stringify","error","text","sessionData","_a","client_secret","value","executeTool","request","getTextToSpeech","signal","blob","generateBearerToken","username","appPassword","btoa","WebRTCService","peerConnection","dataChannel","localStream","startSession","_0","arguments","sessionToken","model","callbacks","RTCPeerConnection","onTrack","ontrack","getTransceivers","forEach","t","sender","track","kind","params","getParameters","encodings","maxBitrate","setParameters","navigator","mediaDevices","getUserMedia","audio","sampleRate","channelCount","sampleSize","echoCancellation","noiseSuppression","autoGainControl","getTracks","addTrack","createDataChannel","ordered","onDataChannelOpen","onopen","onDataChannelMessage","onmessage","onDataChannelError","onerror","offer","createOffer","setLocalDescription","sdpResponse","sdp","answerSdp","setRemoteDescription","type","sendEvent","event","readyState","send","muteMicrophone","getAudioTracks","enabled","unmuteMicrophone","updateTurnDetection","session","turn_detection","threshold","prefix_padding_ms","silence_duration_ms","closeSession","stop","close","AudioService","apiService","isMobileAudioUnlocked","globalAudioContext","isPlayingCustomTts","currentAudioElement","currentAbortController","unlockMobileAudio","audioElement","window","AudioContext","webkitAudioContext","state","resume","warn","wasMuted","muted","playPromise","play","then","pause","currentTime","catch","err","playCustomTtsAudio","onStart","onEnd","AbortController","audioBlob","size","dataset","objectUrl","URL","revokeObjectURL","srcObject","createObjectURL","src","Promise","resolve","reject","checkInterrupted","onended","intervalId","setInterval","clearInterval","originalResolve","interruptCustomTts","abort","cleanup","isPlayingTts","SessionManager","stateManager","webrtcService","audioService","setState","messages","toolCallQueue","currentToolCallId","setSessionData","modalities","includes","updateStatus","handleServerEvent","handleError","streams","e","message","stopSession","getState","updateTranscript","setVadEnabled","data","parse","addMessage","content","transcript","appendTranscript","delta","isCustomTtsEnabled","handleResponseDone","responseOutput","_d","output","_b","_c","responseText","playCustomTts","outputItem","call_id","queueToolCall","toolCall","dequeueToolCall","processToolCall","setPlayingCustomTts","result","tool_name","sendFunctionResult","nextToolCall","callId","item","interruptTts","UIController","elements","typingMessageDiv","showConfigScreen","configScreen","style","display","mainApp","classList","remove","showMainApp","add","showError","configError","textContent","setTimeout","showLoading","show","loadingOverlay","toggleSettingsMenu","settingsMenu","toggle","hideSettingsMenu","clearMessages","chatContainer","innerHTML","appendChild","emptyState","parentNode","messageDiv","document","createElement","className","bubbleDiv","scrollTop","scrollHeight","showTypingIndicator","updateTypingMessage","bubble","querySelector","hideTypingIndicator","hasTypingIndicator","populateConfigForm","siteUrlInput","usernameInput","appPasswordInput","clearConfigForm","disableConnectButton","disabled","connectBtn","MicButtonController","buttonElement","statusElement","currentState","pressTimer","isPressAndHold","pressStartTime","PRESS_HOLD_DELAY","MIN_CLICK_TIME","setupEventListeners","addEventListener","handleClick","handlePressStart","handlePressEnd","handlePressCancel","passive","preventDefault","Date","now","onPressAndHoldStart","pressDuration","clearTimeout","onPressAndHoldEnd","_e","onStartRecording","onInterruptTts","onStopRecording","newState","options","updateUI","getMicIcon","getSoundWaveIcon","getStopIcon","App","sessionManager","lastMessageCount","uiController","micController","micButton","statusText","startRecordingSession","stopRecordingSession","handlePressAndHoldStart","handlePressAndHoldEnd","init","subscribe","onStateChange","configForm","handleConfigSubmit","settingsBtn","stopPropagation","changeConfigBtn","logoutBtn","handleLogout","remoteAudio","once","contains","target","currentTranscript","length","slice","msg","storedPassword","localStorage","getItem","url","trim","protocol","startsWith","cleanUrl","replace","setSiteConfig","setItem","initializeServices","confirm","clearSiteConfig","StateManager","listeners","sessionModalities","updates","__spreadValues","notifyListeners","removeItem","rest","isPlaying","listener","push","filter","l","exports","getElementById","app"],"mappings":"yxCACO,MAAMA,EACC,0BADDA,EAEO,4CAFPA,EAGI,yCAHJA,EAIA,qCAGAC,EACG,qCADHA,EAEI,qCAIJC,EACE,KADFA,EAEI,EAFJA,EAGE,GAHFA,GAIQ,EAJRA,GAKQ,EALRA,GAMQ,EANRA,EAOE,KAIFC,EACa,IAMbC,EACD,sBADCA,EAED,sBAFCA,EAGG,0BAIHC,EACG,qBADHA,EAEC,0BAFDA,EAGA,gBAHAA,EAIC,kBAJDA,EAMa,yBANbA,EAOA,wBAPAA,EAQL,eARKA,EASJ,SAIIC,EACE,6EADFA,EAEU,2DAFVA,EAGI,uDAHJA,EAIQ,4CAJRA,EAKK,kCALLA,EAMY,wBANZA,EAOI,gBAPJA,EAQY,wBARZA,EASC,kDATDA,EAUU,0BAVVA,EAWI,qBC5DV,MAAMC,EACX,WAAAC,CACUC,EACAC,GADAC,KAAAF,QAAAA,EACAE,KAAAD,YAAAA,CAAA,CAGJ,cAAAE,GAAgC,OAAAC,EAAAF,KAAA,KAAA,YAC9B,MAAAG,QAAiBC,MAAM,GAAGJ,KAAKF,UAAUT,IAA4B,CACzEgB,OAAQ,MACRC,KAAM,OACNC,YAAa,OACbC,QAAS,CACPC,cAAe,SAAST,KAAKD,iBAI7B,IAACI,EAASO,GAAI,CACZ,GAAoB,MAApBP,EAASQ,OACL,MAAA,IAAIC,MAAMjB,GAAkC,GACrB,MAApBQ,EAASQ,OAaZ,MAAA,IAAIC,MAAMjB,GAXZ,IACI,MAAAkB,QAAiBV,EAASW,OAChC,KAAID,GAAYA,EAASE,IAAMF,EAASG,MAGhC,MAAA,IAAIJ,MAAMjB,GAFhBsB,QAAQC,IAAI,sDAIPC,GACD,MAAA,IAAIP,MAAMjB,EAA4B,CAIhD,CACF,EAAA,CAGI,aAAAyB,GAA0C,OAAAlB,EAAAF,KAAA,KAAA,kBACxC,MAAAG,QAAiBC,MAAM,GAAGJ,KAAKF,UAAUT,IAAkC,CAC/EgB,OAAQ,OACRE,YAAa,OACbC,QAAS,CACP,eAAgB,mBAChBC,cAAe,SAAST,KAAKD,eAE/BsB,KAAMC,KAAKC,UAAU,CAAE,KAGrB,IAACpB,EAASO,GAAI,CACV,MAAAc,QAAcrB,EAASsB,OAC7B,MAAM,IAAIb,MAAM,GAAGjB,MAAkC6B,IAAO,CAGxD,MAAAE,QAAoBvB,EAASW,OAC/B,KAAC,OAAAa,EAAAD,EAAYE,oBAAZ,EAAAD,EAA2BE,OACxB,MAAA,IAAIjB,MAAM,4BAGX,OAAAc,CAAA,EAAA,CAGH,WAAAI,CAAYC,GAA+D,OAAA7B,EAAAF,KAAA,KAAA,YACzE,MAAAG,QAAiBC,MAAM,GAAGJ,KAAKF,UAAUT,IAA+B,CAC5EgB,OAAQ,OACRE,YAAa,OACbC,QAAS,CACP,eAAgB,mBAChBC,cAAe,SAAST,KAAKD,eAE/BsB,KAAMC,KAAKC,UAAUQ,KAIhB,aADc5B,EAASW,MACvB,EAAA,CAGH,eAAAkB,CAAgBP,EAAcQ,GAAqC,OAAA/B,EAAAF,KAAA,KAAA,YACjE,MAAAG,QAAiBC,MAAM,GAAGJ,KAAKF,UAAUT,IAA2B,CACxEgB,OAAQ,OACRE,YAAa,OACbC,QAAS,CACP,eAAgB,mBAChBC,cAAe,SAAST,KAAKD,eAE/BsB,KAAMC,KAAKC,UAAU,CAAEE,SACvBQ,WAGE,IAAC9B,EAASO,GACZ,MAAM,IAAIE,MAAM,kCAAkCT,EAASQ,UAGtD,aAAMR,EAAS+B,MAAK,EAAA,CAG7B,0BAAOC,CAAoBC,EAAkBC,GAE3C,OAAOC,KADa,GAAGF,KAAYC,IACZ,EC1FpB,MAAME,EAAN,WAAA1C,GACLG,KAAQwC,eAA2C,KACnDxC,KAAQyC,YAAqC,KAC7CzC,KAAQ0C,YAAkC,IAAA,CAEpC,YAAAC,CACJC,GAGe,OAAA1C,EAAAF,KAAA6C,UAAA,UAHfC,EACAC,EAAgBzD,EAChB0D,EAA6B,IAGxBhD,KAAAwC,eAAiB,IAAIS,kBAGtBD,EAAUE,UACPlD,KAAAwC,eAAeW,QAAUH,EAAUE,SAI1ClD,KAAKwC,eAAeY,kBAAkBC,QAASC,UAC7C,GAA6B,WAAzB,OAAA3B,EAAE2B,EAAAC,OAAOC,YAAT,EAAA7B,EAAgB8B,MAAkB,CAC9B,MAAAC,EAASJ,EAAEC,OAAOI,gBACxBD,EAAOE,UAAY,CAAC,CAAEC,WAAYtE,IAChC+D,EAAAC,OAAOO,cAAcJ,EAAM,IAKjC1D,KAAK0C,kBAAoBqB,UAAUC,aAAaC,aAAa,CAC3DC,MAAO,CACLC,WAAY5E,EACZ6E,aAAc7E,EACd8E,WAAY9E,EACZ+E,iBAAkB/E,EAClBgF,iBAAkBhF,EAClBiF,gBAAiBjF,KAKrBS,KAAK0C,YAAY+B,YAAYpB,QAASG,IACpCxD,KAAKwC,eAAgBkC,SAASlB,EAAOxD,KAAK0C,eAI5C1C,KAAKyC,YAAczC,KAAKwC,eAAemC,kBAAkB,aAAc,CACrEC,SAAS,IAGP5B,EAAU6B,oBACP7E,KAAAyC,YAAYqC,OAAS9B,EAAU6B,mBAGlC7B,EAAU+B,uBACP/E,KAAAyC,YAAYuC,UAAYhC,EAAU+B,sBAGrC/B,EAAUiC,qBACPjF,KAAAyC,YAAYyC,QAAUlC,EAAUiC,oBAIvC,MAAME,QAAcnF,KAAKwC,eAAe4C,oBAClCpF,KAAKwC,eAAe6C,oBAAoBF,GAExC,MAAAG,QAAoBlF,MAAM,GAAGd,WAAiCyD,IAAS,CAC3E1C,OAAQ,OACRgB,KAAM8D,EAAMI,IACZ/E,QAAS,CACPC,cAAe,UAAUqC,IACzB,eAAgB,qBAIhB,IAACwC,EAAY5E,GACf,MAAM,IAAIE,MAAM,2BAA2B0E,EAAY3E,UAGnD,MAAA6E,QAAkBF,EAAY7D,aAC9BzB,KAAKwC,eAAeiD,qBAAqB,CAC7CC,KAAM,SACNH,IAAKC,GACN,EAAA,CAGH,SAAAG,CAAUC,GACR,IAAK5F,KAAKyC,aAA+C,SAAhCzC,KAAKyC,YAAYoD,WAClC,MAAA,IAAIjF,MAAM,yBAElBZ,KAAKyC,YAAYqD,KAAKxE,KAAKC,UAAUqE,GAAM,CAG7C,cAAAG,GACM/F,KAAK0C,aACP1C,KAAK0C,YAAYsD,iBAAiB3C,QAASG,IACzCA,EAAMyC,SAAU,GAEpB,CAGF,gBAAAC,GACMlG,KAAK0C,aACP1C,KAAK0C,YAAYsD,iBAAiB3C,QAASG,IACzCA,EAAMyC,SAAU,GAEpB,CAGF,mBAAAE,CAAoB7F,GACVW,QAAAC,IAAI,wDAAyDZ,GACrE,MAAMsF,EAAuB,CAC3BF,KAAM,iBACNU,QAAS,CACPC,eACW,eAAT/F,EACI,CACEoF,KAAM,aACNY,UAAW,GACXC,kBAAmB,IACnBC,oBAAqB,KAEvB,OAGFvF,QAAAC,IAAI,gDAAiD0E,GAC7D5F,KAAK2F,UAAUC,EAAK,CAGtB,YAAAa,GACMzG,KAAK0C,cACF1C,KAAA0C,YAAY+B,YAAYpB,QAASG,GAAUA,EAAMkD,QACtD1G,KAAK0C,YAAc,MAEjB1C,KAAKyC,cACPzC,KAAKyC,YAAYkE,QACjB3G,KAAKyC,YAAc,MAEjBzC,KAAKwC,iBACPxC,KAAKwC,eAAemE,QACpB3G,KAAKwC,eAAiB,KACxB,ECnJG,MAAMoE,EAOX,WAAA/G,CAAoBgH,GAAA7G,KAAA6G,WAAAA,EANpB7G,KAAQ8G,uBAAwB,EAChC9G,KAAQ+G,mBAA0C,KAClD/G,KAAQgH,oBAAqB,EAC7BhH,KAAQiH,oBAA+C,KACvDjH,KAAQkH,uBAAiD,IAAA,CAQzD,iBAAAC,CAAkBC,GAChB,IAAIpH,KAAK8G,sBAAT,CACA9G,KAAK8G,uBAAwB,EAGzB,IACF9G,KAAK+G,mBACH/G,KAAK+G,oBACL,IAAKM,OAAOC,cACTD,OAAkEE,oBACjC,cAAlCvH,KAAK+G,mBAAmBS,OAC1BxH,KAAK+G,mBAAmBU,eAEnBjG,GACCP,QAAAyG,KAAK,sCAAuClG,EAAK,CAI3D,GAAI4F,EAAc,CAChB,MAAMO,EAAWP,EAAaQ,MAC9BR,EAAaQ,OAAQ,EAEf,MAAAC,EAAcT,EAAaU,OAC7BD,GAA2C,mBAArBA,EAAYE,KACpCF,EACGE,KAAK,KACJX,EAAaY,QACbZ,EAAaa,YAAc,EAC3Bb,EAAaQ,MAAQD,EACrB1G,QAAQC,IAAI,0CAEbgH,MAAOC,IACElH,QAAAyG,KAAK,uCAAwCS,GACrDf,EAAaQ,MAAQD,IAGzBP,EAAaQ,MAAQD,CACvB,CApC8B,CAqChC,CAMI,kBAAAS,CACJ3G,EACA2F,EACAiB,EACAC,GACe,OAAApI,EAAAF,KAAA,KAAA,YACf,GAAKyB,EAAL,CAKQR,QAAAC,IAAI,yCAA0CO,GAElD,IACFzB,KAAKgH,oBAAqB,EAC1BhH,KAAKiH,oBAAsBG,EAEvBiB,GAAiBA,IAErBpH,QAAQC,IAAI,iDAGPlB,KAAAkH,uBAAyB,IAAIqB,gBAE5B,MAAAC,QAAkBxI,KAAK6G,WAAW7E,gBAAgBP,EAAMzB,KAAKkH,uBAAuBjF,QAI1F,GAHQhB,QAAAC,IAAI,4CAA6CsH,EAAUC,OAG9DzI,KAAKgH,qBAAuBI,EAC/B,OAIEA,EAAasB,QAAQC,YACnBC,IAAAC,gBAAgBzB,EAAasB,QAAQC,kBAClCvB,EAAasB,QAAQC,WAG9BvB,EAAa0B,UAAY,KACnB,MAAAH,EAAYC,IAAIG,gBAAgBP,GACtCpB,EAAasB,QAAQC,UAAYA,EACjCvB,EAAa4B,IAAML,QAEbvB,EAAaU,aAGb,IAAImB,QAAc,CAACC,EAASC,KAChC,MAAMC,EAAmB,KAClBpJ,KAAKgH,qBACRI,EAAaY,QACLkB,MAIC9B,EAAAiC,QAAU,IAAMH,IAC7B9B,EAAalC,QAAU,IAAMiE,EAAO,IAAIvI,MAAM,yBAGxC,MAAA0I,EAAaC,YAAY,KACZH,IACZpJ,KAAKgH,oBACRwC,cAAcF,IAEf,KAGGG,EAAkBP,EACxBA,EAAU,KACRM,cAAcF,GACEG,OAKpBb,IAAIC,gBAAgBF,UACbvB,EAAasB,QAAQC,gBACrBR,GAEP,KAAIA,aAAevH,OAAsB,eAAbuH,EAAInH,MAIxB,MADEC,QAAAO,MAAM,oCAAqC2G,GAC7C,IAAIvH,MAAMjB,GAHhBsB,QAAQC,IAAI,yCAId,CACA,QACAlB,KAAKkH,uBAAyB,KAC9BlH,KAAKgH,oBAAqB,EAC1BhH,KAAKiH,oBAAsB,KACvBqB,GAAaA,GAAA,CAhFjB,MADArH,QAAQC,IAAI,0CAkFd,EAAA,CAMF,kBAAAwI,GAEM1J,KAAKkH,yBACPlH,KAAKkH,uBAAuByC,QAC5B3J,KAAKkH,uBAAyB,KAC9BjG,QAAQC,IAAI,uCAGVlB,KAAKgH,oBAAsBhH,KAAKiH,sBAClCjH,KAAKgH,oBAAqB,EAC1BhH,KAAKiH,oBAAoBe,QACzBhI,KAAKiH,oBAAoBgB,YAAc,EAEnCjI,KAAKiH,oBAAoByB,QAAQC,YACnCC,IAAIC,gBAAgB7I,KAAKiH,oBAAoByB,QAAQC,kBAC9C3I,KAAKiH,oBAAoByB,QAAQC,WAG1C1H,QAAQC,IAAI,kCACd,CAMF,OAAA0I,CAAQxC,GACNpH,KAAK0J,qBAEDtC,IACFA,EAAaY,QACbZ,EAAaa,YAAc,EAC3Bb,EAAa0B,UAAY,KACzB1B,EAAa4B,IAAM,GAEf5B,EAAasB,QAAQC,YACnBC,IAAAC,gBAAgBzB,EAAasB,QAAQC,kBAClCvB,EAAasB,QAAQC,WAG9BvB,EAAaiC,QAAU,KACzB,CAGF,gBAAIQ,GACF,OAAO7J,KAAKgH,kBAAA,ECzLT,MAAM8C,EAIX,WAAAjK,CACUkK,EACAlD,EACAO,GAFApH,KAAA+J,aAAAA,EACA/J,KAAA6G,WAAAA,EACA7G,KAAAoH,aAAAA,EAEHpH,KAAAgK,cAAgB,IAAIzH,EACpBvC,KAAAiK,aAAe,IAAIrD,EAAaC,EAAU,CAG3C,YAAAlE,GAA8B,OAAAzC,EAAAF,KAAA,KAAA,kBAC9B,IAEFA,KAAK+J,aAAaG,SAAS,CACzBvJ,OAAQ,aACRwJ,SAAU,GACVC,cAAe,GACfC,kBAAmB,OAIrB,MAAM3I,QAAoB1B,KAAK6G,WAAWzF,gBAC1CpB,KAAK+J,aAAaO,eAChB5I,EAAYE,cAAcC,MAC1BH,EAAY6I,YAAc,CAAC,OAAQ,UAG7BtJ,QAAAC,IAAI,sBAAuBQ,EAAY6I,YAC/CtJ,QAAQC,IAAI,wBAAwB,OAAAS,IAAY4I,iBAAZ,EAAA5I,EAAwB6I,SAAS,iBAG/DxK,KAAKgK,cAAcrH,aAAajB,EAAYE,cAAcC,MAAOH,EAAYqB,MAAO,CACxF8B,kBAAmB,KACZ7E,KAAA+J,aAAaU,aAAa,cAEjC1F,qBAAuBa,GAAU5F,KAAK0K,kBAAkB9E,GACxDX,mBAAqBzD,IACXP,QAAAO,MAAM,sBAAuBA,GAChCxB,KAAA2K,YAAYhL,IAEnBuD,QAAU0C,IACJ5F,KAAKoH,cAAgBxB,EAAMgF,SAAWhF,EAAMgF,QAAQ,KACtD5K,KAAKoH,aAAa0B,UAAYlD,EAAMgF,QAAQ,GACvC5K,KAAAoH,aAAaU,OAAOI,MAAO2C,GAAM5J,QAAQO,MAAM,oBAAqBqJ,cAIxErJ,GACCP,QAAAO,MAAM,uBAAwBA,GACtCxB,KAAK2K,YAAanJ,EAAgBsJ,SAAWnL,GAC7CK,KAAK+K,aAAY,CACnB,EAAA,CAGF,WAAAA,GAEM/K,KAAK+J,aAAaiB,WAAWhE,oBAC/BhH,KAAKiK,aAAaP,qBAGpB1J,KAAKgK,cAAcvD,eACdzG,KAAAiK,aAAaL,QAAQ5J,KAAKoH,cAC1BpH,KAAA+J,aAAaU,aAAa,gBAC1BzK,KAAA+J,aAAakB,iBAAiB,GAAE,CAGvC,aAAAC,CAAcjF,GACJhF,QAAAC,IAAI,8CAA+C+E,GACvD,IACFjG,KAAKgK,cAAc7D,oBAAoBF,EAAU,aAAe,QAChEhF,QAAQC,IAAI,wBAAwB+E,EAAU,UAAY,oCAGtDA,IACFhF,QAAQC,IAAI,gEACZlB,KAAKgK,cAAcrE,UAAU,CAC3BD,KAAM,8BAIRzE,QAAQC,IAAI,0DACZlB,KAAKgK,cAAcrE,UAAU,CAC3BD,KAAM,2BAGHlE,GACCP,QAAAO,MAAM,yCAA0CA,EAAK,CAC/D,CAGY,iBAAAkJ,CAAkB9E,GAAoC,OAAA1F,EAAAF,KAAA,KAAA,YAC9D,IACF,MAAMmL,EAAsB7J,KAAK8J,MAAMxF,EAAMuF,MAC7ClK,QAAQC,IAAI,gBAAiBiK,EAAKzF,KAAMyF,GAElC,MAAA3D,EAAQxH,KAAK+J,aAAaiB,WAEhC,OAAQG,EAAKzF,MACX,IAAK,oCACH1F,KAAKgK,cAAc9D,mBACdlG,KAAA+J,aAAaU,aAAa,aAC/B,MAEF,IAAK,oCACEzK,KAAA+J,aAAaU,aAAa,cAC/B,MAEF,IAAK,wDACHzK,KAAK+J,aAAasB,WAAW,CAC3B3F,KAAM,OACN4F,QAAUH,EAA4BI,aAExC,MAEF,IAAK,mBACEvL,KAAA+J,aAAakB,iBAAiB,IACnC,MAEF,IAAK,kCACL,IAAK,sBACHjL,KAAK+J,aAAayB,iBAAkBL,EAAoBM,OAAS,IACjE,MAEF,IAAK,uBACEjE,EAAMkE,oBACJ1L,KAAA+J,aAAaU,aAAa,YAEjC,MAEF,IAAK,yCAEkB,cAAjBjD,EAAM7G,QACHX,KAAA+J,aAAaU,aAAa,aAEjC,MAEF,IAAK,sBACGzK,KAAK2L,mBAAmBR,GAC9B,MAEF,IAAK,8BACE3D,EAAMkE,oBACJ1L,KAAA+J,aAAaU,aAAa,QAEjC,MAEF,IAAK,QACKxJ,QAAAO,MAAM,aAAc2J,GAC5BnL,KAAK2K,YAAaQ,EAAoBL,SAAWnL,UAG9C6B,GACCP,QAAAO,MAAM,8BAA+BA,EAAK,CACpD,EAAA,CAGY,kBAAAmK,CAAmBR,GAAwC,OAAAjL,EAAAF,KAAA,KAAA,wBAInE,GAFCA,KAAA+J,aAAakB,iBAAiB,IAEN,WAAzBE,EAAKhL,SAASQ,OAEhB,YADKX,KAAA+J,aAAaU,aAAa,SAI3B,MAAAmB,EAAiB,OAAAC,EAAA,SAAA,SAAA,WAAK1L,eAAL,EAAAwB,EAAemK,aAAS,EAAAC,EAAA,SAAI,EAAAC,EAAAV,cAAU,EAAAO,EAAA,GACvDI,GAA+B,MAAhBL,OAAgB,EAAAA,EAAAnK,QAAwB,MAAhBmK,OAAgB,EAAAA,EAAAL,YAEzDU,GACFjM,KAAK+J,aAAasB,WAAW,CAAE3F,KAAM,YAAa4F,QAASW,IAI/CjM,KAAK+J,aAAaiB,WACtBU,oBAAsBO,UACxBjM,KAAKkM,cAAcD,IAIvBd,EAAKhL,SAAS2L,QAChBX,EAAKhL,SAAS2L,OAAOzI,QAAS8I,IAEN,kBAApBA,EAAWzG,MACXyG,EAAWC,SACXD,EAAWnL,MACXmL,EAAWtJ,WAEX7C,KAAK+J,aAAasC,cAAc,CAC9BrL,KAAMmL,EAAWnL,KACjB6B,UAAWsJ,EAAWtJ,UACtBuJ,QAASD,EAAWC,YAOtB,MAAAE,EAAWtM,KAAK+J,aAAawC,kBAC/BD,UACItM,KAAKwM,gBAAgBF,GAC7B,EAAA,CAGY,aAAAJ,CAAczK,GAA6B,OAAAvB,EAAAF,KAAA,KAAA,YAC/CiB,QAAAC,IAAI,iDAAkDO,GAC1D,UACIzB,KAAKiK,aAAa7B,mBACtB3G,EACAzB,KAAKoH,aACL,KACEnG,QAAQC,IAAI,uCACPlB,KAAA+J,aAAa0C,qBAAoB,GACjCzM,KAAA+J,aAAaU,aAAa,YAC/BzK,KAAKgK,cAAcjE,kBAErB,KACE9E,QAAQC,IAAI,qCAES,iBADPlB,KAAK+J,aAAaiB,WACtBrK,SACHX,KAAA+J,aAAa0C,qBAAoB,GACtCzM,KAAKgK,cAAc9D,mBACdlG,KAAA+J,aAAaU,aAAa,sBAI9BjJ,GACCP,QAAAO,MAAM,oBAAqBA,GACS,iBAAxCxB,KAAK+J,aAAaiB,WAAWrK,QAC1BX,KAAA2K,YAAYhL,EACnB,CACF,EAAA,CAGY,eAAA6M,CAAgBF,GAAmC,OAAApM,EAAAF,KAAA,KAAA,YAE3D,IACF,MAAM0M,QAAe1M,KAAK6G,WAAW/E,YAAY,CAC/C6K,UAAWL,EAAStL,KACpB6B,UAAWyJ,EAASzJ,YAGjB6J,EAAOlL,MAGLxB,KAAA4M,mBAAmBN,EAASF,QAAS,CACxC5K,OAAO,EACPsJ,QAAS4B,EAAO5B,SAAWnL,IAJxBK,KAAA4M,mBAAmBN,EAASF,QAASM,SAOrClL,GACFxB,KAAA4M,mBAAmBN,EAASF,QAAS,CACxC5K,OAAO,EACPsJ,QAASnL,GACV,CAIG,MAAAkN,EAAe7M,KAAK+J,aAAawC,kBACnCM,UACI7M,KAAKwM,gBAAgBK,GAC7B,EAAA,CAGM,kBAAAD,CAAmBE,EAAgBJ,GACrC,IAEF1M,KAAKgK,cAAcrE,UAAU,CAC3BD,KAAM,2BACNqH,KAAM,CACJrH,KAAM,uBACN0G,QAASU,EACThB,OAAQxK,KAAKC,UAAUmL,MAK3B1M,KAAKgK,cAAcrE,UAAU,CAC3BD,KAAM,0BAEDlE,GACFxB,KAAA2K,YAAYhL,EAAoC,CACvD,CAGF,YAAAqN,GACMhN,KAAK+J,aAAaiB,WAAWhE,mBAC/BhH,KAAKiK,aAAaP,qBAElB1J,KAAK+K,aACP,CAGM,WAAAJ,CAAYG,GACV7J,QAAAO,MAAM,SAAUsJ,GACnB9K,KAAA+J,aAAaU,aAAa,QAAO,ECpTnC,MAAMwC,EAGX,WAAApN,CAAoBqN,GAAAlN,KAAAkN,SAAAA,EAFpBlN,KAAQmN,iBAA0C,IAAA,CAIlD,gBAAAC,GACOpN,KAAAkN,SAASG,aAAaC,MAAMC,QAAU,OAC3CvN,KAAKkN,SAASM,QAAQC,UAAUC,OAAO,SAAQ,CAGjD,WAAAC,GACO3N,KAAAkN,SAASG,aAAaC,MAAMC,QAAU,OAC3CvN,KAAKkN,SAASM,QAAQC,UAAUG,IAAI,SAAQ,CAG9C,SAAAC,CAAU/C,GACH9K,KAAAkN,SAASY,YAAYC,YAAcjD,EACnC9K,KAAAkN,SAASY,YAAYR,MAAMC,QAAU,QAC1CS,WAAW,KACJhO,KAAAkN,SAASY,YAAYR,MAAMC,QAAU,QACzC/N,EAAgC,CAGrC,WAAAyO,CAAYC,GACVlO,KAAKkN,SAASiB,eAAeb,MAAMC,QAAUW,EAAO,OAAS,MAAA,CAG/D,kBAAAE,GACEpO,KAAKkN,SAASmB,aAAaZ,UAAUa,OAAO,SAAQ,CAGtD,gBAAAC,GACEvO,KAAKkN,SAASmB,aAAaZ,UAAUC,OAAO,SAAQ,CAGtD,aAAAc,GACOxO,KAAAkN,SAASuB,cAAcC,UAAY,GACxC1O,KAAKkN,SAASuB,cAAcE,YAAY3O,KAAKkN,SAAS0B,WAAU,CAGlE,UAAAvD,CAAWP,GACL9K,KAAKkN,SAAS0B,WAAWC,YACtB7O,KAAAkN,SAAS0B,WAAWlB,SAGrB,MAAAoB,EAAaC,SAASC,cAAc,OAC/BF,EAAAG,UAAY,gBAAgBnE,EAAQpF,OAEzC,MAAAwJ,EAAYH,SAASC,cAAc,OACzCE,EAAUD,UAAY,iBACtBC,EAAUnB,YAAcjD,EAAQQ,QAEhCwD,EAAWH,YAAYO,GAClBlP,KAAAkN,SAASuB,cAAcE,YAAYG,GAGxC9O,KAAKkN,SAASuB,cAAcU,UAAYnP,KAAKkN,SAASuB,cAAcW,YAAA,CAGtE,mBAAAC,GACMrP,KAAKkN,SAAS0B,WAAWC,YACtB7O,KAAAkN,SAAS0B,WAAWlB,SAGtB1N,KAAAmN,iBAAmB4B,SAASC,cAAc,OAC/ChP,KAAKmN,iBAAiB8B,UAAY,yBAClCjP,KAAKmN,iBAAiBpM,GAAK,gBAErB,MAAAmO,EAAYH,SAASC,cAAc,OACzCE,EAAUD,UAAY,wBACtBC,EAAUR,UAAY,iIAMjB1O,KAAAmN,iBAAiBwB,YAAYO,GAClClP,KAAKkN,SAASuB,cAAcE,YAAY3O,KAAKmN,kBAG7CnN,KAAKkN,SAASuB,cAAcU,UAAYnP,KAAKkN,SAASuB,cAAcW,YAAA,CAGtE,mBAAAE,CAAoB7N,GACd,GAAAzB,KAAKmN,kBAAoB1L,EAAM,CACjC,MAAM8N,EAASvP,KAAKmN,iBAAiBqC,cAAc,mBAC/CD,IACFA,EAAON,UAAY,iBACnBM,EAAOxB,YAActM,EAGrBzB,KAAKkN,SAASuB,cAAcU,UAAYnP,KAAKkN,SAASuB,cAAcW,aACtE,CACF,CAGF,mBAAAK,GACMzP,KAAKmN,mBACPnN,KAAKmN,iBAAiBO,SACtB1N,KAAKmN,iBAAmB,KAC1B,CAGF,kBAAAuC,GACE,OAAiC,OAA1B1P,KAAKmN,gBAAqB,CAGnC,kBAAAwC,CAAmB7P,EAAiBsC,GAC7BpC,KAAAkN,SAAS0C,aAAa/N,MAAQ/B,EAC9BE,KAAAkN,SAAS2C,cAAchO,MAAQO,EAC/BpC,KAAAkN,SAAS4C,iBAAiBjO,MAAQ,EAAA,CAGzC,eAAAkO,GACO/P,KAAAkN,SAAS0C,aAAa/N,MAAQ,GAC9B7B,KAAAkN,SAAS2C,cAAchO,MAAQ,GAC/B7B,KAAAkN,SAAS4C,iBAAiBjO,MAAQ,EAAA,CAGzC,oBAAAmO,CAAqBC,EAAmBxO,GACjCzB,KAAAkN,SAASgD,WAAWD,SAAWA,EAChCxO,IACGzB,KAAAkN,SAASgD,WAAWnC,YAActM,EACzC,ECnHG,MAAM0O,EAWX,WAAAtQ,CACEuQ,EACAC,EACArN,GAbFhD,KAAQsQ,aAA0B,eAIlCtQ,KAAQuQ,WAA4B,KACpCvQ,KAAQwQ,gBAA0B,EAClCxQ,KAAQyQ,eAAyB,EACjCzQ,KAAiB0Q,iBAAmB,IACpC1Q,KAAiB2Q,eAAiB,GAOhC3Q,KAAKoQ,cAAgBA,EACrBpQ,KAAKqQ,cAAgBA,EACrBrQ,KAAKgD,UAAYA,EACjBhD,KAAK4Q,qBAAoB,CAGnB,mBAAAA,GAED5Q,KAAAoQ,cAAcS,iBAAiB,QAAS,KAEtC7Q,KAAKwQ,gBAA0C,IAAxBxQ,KAAKyQ,gBAC/BzQ,KAAK8Q,gBAKJ9Q,KAAAoQ,cAAcS,iBAAiB,YAAchG,GAAM7K,KAAK+Q,iBAAiBlG,IACzE7K,KAAAoQ,cAAcS,iBAAiB,UAAYhG,GAAM7K,KAAKgR,eAAenG,IACrE7K,KAAAoQ,cAAcS,iBAAiB,aAAehG,GAAM7K,KAAKiR,kBAAkBpG,IAG3E7K,KAAAoQ,cAAcS,iBAAiB,aAAehG,GAAM7K,KAAK+Q,iBAAiBlG,GAAI,CACjFqG,SAAS,IAENlR,KAAAoQ,cAAcS,iBAAiB,WAAahG,GAAM7K,KAAKgR,eAAenG,GAAI,CAC7EqG,SAAS,IAENlR,KAAAoQ,cAAcS,iBAAiB,cAAgBhG,GAAM7K,KAAKiR,kBAAkBpG,GAAE,CAG7E,gBAAAkG,CAAiBlG,GACvB5J,QAAQC,IAAI,iCAAkC2J,EAAEnF,KAAM,iBAAkB1F,KAAKsQ,cAG9D,eAAXzF,EAAEnF,MACJmF,EAAEsG,iBAGCnR,KAAAyQ,eAAiBW,KAAKC,MAC3BrR,KAAKwQ,gBAAiB,EAGI,cAAtBxQ,KAAKsQ,cACPrP,QAAQC,IAAI,qDAEPlB,KAAAuQ,WAAalJ,OAAO2G,WAAW,KAClChO,KAAKwQ,gBAAiB,EACtBvP,QAAQC,IAAI,wCAGPlB,KAAAoQ,cAAc3C,UAAUG,IAAI,kBAE7B5N,KAAKgD,UAAUsO,sBACjBrQ,QAAQC,IAAI,oDACZlB,KAAKgD,UAAUsO,wBAEhBtR,KAAK0Q,mBAERzP,QAAQC,IAAI,8DACd,CAGM,cAAA8P,CAAenG,GACrB,MAAM0G,EAAgBH,KAAKC,MAAQrR,KAAKyQ,eAChCxP,QAAAC,IAAI,+BAAgC2J,EAAEnF,KAAM,YAAa6L,EAAe,KAAM,kBAAmBvR,KAAKwQ,gBAE/F,aAAX3F,EAAEnF,MACJmF,EAAEsG,iBAIAnR,KAAKuQ,aACPiB,aAAaxR,KAAKuQ,YAClBvQ,KAAKuQ,WAAa,MAIhBvQ,KAAKwQ,gBAAkBxQ,KAAKgD,UAAUyO,mBACxCxQ,QAAQC,IAAI,yEAGPlB,KAAAoQ,cAAc3C,UAAUC,OAAO,kBAEpC1N,KAAKgD,UAAUyO,oBAEfzR,KAAKwQ,gBAAiB,GAEtBxQ,KAAKyQ,eAAiB,GACtBc,GAAiBvR,KAAK2Q,gBACtBY,EAAgBvR,KAAK0Q,mBAGrBzP,QAAQC,IAAI,4DACZlB,KAAK8Q,eAIP9Q,KAAKwQ,gBAAiB,EACtBxQ,KAAKyQ,eAAiB,CAAA,CAGhB,iBAAAQ,CAAkBS,GACxBzQ,QAAQC,IAAI,+BAGRlB,KAAKuQ,aACPiB,aAAaxR,KAAKuQ,YAClBvQ,KAAKuQ,WAAa,MAGhBvQ,KAAKwQ,gBAAkBxQ,KAAKgD,UAAUyO,oBACxCxQ,QAAQC,IAAI,mEAGPlB,KAAAoQ,cAAc3C,UAAUC,OAAO,kBAEpC1N,KAAKgD,UAAUyO,qBAGjBzR,KAAKwQ,gBAAiB,EACtBxQ,KAAKyQ,eAAiB,CAAA,CAGxB,WAAAK,GACE,OAAQ9Q,KAAKsQ,cACX,IAAK,eACL,IAAK,QACHtQ,KAAKgD,UAAU2O,mBACf,MAEF,IAAK,WACH3R,KAAKgD,UAAU4O,iBACf,MAEF,IAAK,YACL,IAAK,aACL,IAAK,YACL,IAAK,OACH5R,KAAKgD,UAAU6O,kBACf,MAEF,IAAK,aAEH,MAEF,QACU5Q,QAAAyG,KAAK,4BAA6B1H,KAAKsQ,cACnD,CAGF,QAAApG,CAAS4H,EAAqBC,EAAgC,IAC5D9Q,QAAQC,IAAI,eAAelB,KAAKsQ,kBAAkBwB,KAClD9R,KAAKsQ,aAAewB,EACf9R,KAAAgS,SAASF,EAAUC,EAAO,CAGzB,QAAAC,CAASxK,EAAkBuK,EAAgC,IAKjE,OAJA/R,KAAKoQ,cAAcnB,UAAY,aAC/BjP,KAAKoQ,cAAc1B,UAAY,GAC/B1O,KAAKoQ,cAAcH,UAAW,EAEtBzI,GACN,IAAK,eACExH,KAAAqQ,cAActC,YAAcrO,EACjCM,KAAKqQ,cAAcpB,UAAY,cAC1BjP,KAAAoQ,cAAc1B,UAAY1O,KAAKiS,aACpC,MAEF,IAAK,aACEjS,KAAAqQ,cAActC,YAAcrO,EACjCM,KAAKqQ,cAAcpB,UAAY,cAC/BjP,KAAKoQ,cAAc1B,UAAY,8BAC/B1O,KAAKoQ,cAAcH,UAAW,EAC9B,MAEF,IAAK,YACEjQ,KAAAqQ,cAActC,YAAcrO,EACjCM,KAAKqQ,cAAcpB,UAAY,cAC1BjP,KAAAoQ,cAAc3C,UAAUG,IAAI,aAC5B5N,KAAAoQ,cAAc1B,UAAY1O,KAAKkS,mBACpC,MAEF,IAAK,aACElS,KAAAqQ,cAActC,YAAcrO,EACjCM,KAAKqQ,cAAcpB,UAAY,cAC/BjP,KAAKoQ,cAAc1B,UAAY,8BAC/B,MAEF,IAAK,WACE1O,KAAAqQ,cAActC,YAAcrO,EACjCM,KAAKqQ,cAAcpB,UAAY,cAC/BjP,KAAKoQ,cAAcH,UAAW,EACzBjQ,KAAAoQ,cAAc1B,UAAY1O,KAAKmS,cACpC,MAEF,IAAK,YACEnS,KAAAqQ,cAActC,YAAcrO,EACjCM,KAAKqQ,cAAcpB,UAAY,cAC/BjP,KAAKoQ,cAAc1B,UAAY,8BAC/B,MAEF,IAAK,OACE1O,KAAAqQ,cAActC,YAAcrO,EACjCM,KAAKqQ,cAAcpB,UAAY,cAC1BjP,KAAAoQ,cAAc1B,UAAY1O,KAAKmS,cACpC,MAEF,IAAK,QACHnS,KAAKqQ,cAActC,YAAcgE,EAAQjH,SAAWpL,EACpDM,KAAKqQ,cAAcpB,UAAY,oBAC1BjP,KAAAoQ,cAAc1B,UAAY1O,KAAKiS,aAExC,CAGM,UAAAA,GACC,MAAA,uSAAA,CAQD,WAAAE,GACC,MAAA,sIAAA,CAOD,gBAAAD,GACC,MAAA,mQAAA,EC3PJ,MAAME,EASX,WAAAvS,CACUqN,EACAnD,GADA/J,KAAAkN,SAAAA,EACAlN,KAAA+J,aAAAA,EARV/J,KAAQqS,eAAwC,KAEhDrS,KAAQ6G,WAAgC,KACxC7G,KAAQiK,aAAoC,KAC5CjK,KAAQsS,iBAAmB,EAMpBtS,KAAAuS,aAAe,IAAItF,EAAaC,GACrClN,KAAKwS,cAAgB,IAAIrC,EAAoBjD,EAASuF,UAAWvF,EAASwF,WAAY,CACpFf,iBAAkB,IAAM3R,KAAK2S,wBAC7Bd,gBAAiB,IAAM7R,KAAK4S,uBAC5BhB,eAAgB,IAAM5R,KAAKgN,eAC3BsE,oBAAqB,IAAMtR,KAAK6S,0BAChCpB,kBAAmB,IAAMzR,KAAK8S,yBAC/B,CAGG,IAAAC,GAAsB,OAAA7S,EAAAF,KAAA,KAAA,YAE1BA,KAAK4Q,sBAGL5Q,KAAK+J,aAAaiJ,UAAWxL,GAAUxH,KAAKiT,cAAczL,IAGpD,MAAAA,EAAQxH,KAAK+J,aAAaiB,WAC5BxD,EAAM1H,SAAWE,KAAKmC,uBACnBnC,KAAAkN,SAAS0C,aAAa/N,MAAQ2F,EAAM1H,QACpCE,KAAAkN,SAAS2C,cAAchO,MAAQ2F,EAAMpF,SAI1CpC,KAAKuS,aAAa5E,eAElB3N,KAAKuS,aAAanF,kBACpB,EAAA,CAGM,mBAAAwD,GAED5Q,KAAAkN,SAASgG,WAAWrC,iBAAiB,SAAWhG,GAAM7K,KAAKmT,mBAAmBtI,IAGnF7K,KAAKkN,SAASkG,YAAYvC,iBAAiB,QAAUhG,IACnDA,EAAEwI,kBACFrT,KAAKuS,aAAanE,uBAIpBpO,KAAKkN,SAASoG,gBAAgBzC,iBAAiB,QAAS,KACtD7Q,KAAKuS,aAAahE,mBAClBvO,KAAKuS,aAAanF,mBAClBpN,KAAKuS,aAAa5C,mBAChB3P,KAAK+J,aAAaiB,WAAWlL,QAC7BE,KAAK+J,aAAaiB,WAAW5I,YAKjCpC,KAAKkN,SAASqG,UAAU1C,iBAAiB,QAAS,IAAM7Q,KAAKwT,gBAG7DxT,KAAKkN,SAASuF,UAAU5B,iBACtB,QACA,KACM7Q,KAAKiK,cACPjK,KAAKiK,aAAa9C,kBAAkBnH,KAAKkN,SAASuG,cAGtD,CAAEC,MAAM,IAID3E,SAAA8B,iBAAiB,QAAUhG,IAE/B7K,KAAKkN,SAASkG,YAAYO,SAAS9I,EAAE+I,SACrC5T,KAAKkN,SAASmB,aAAasF,SAAS9I,EAAE+I,SAEvC5T,KAAKuS,aAAahE,oBAErB,CAGK,aAAA0E,CAAczL,GAEfxH,KAAAwS,cAActI,SAAS1C,EAAM7G,QAG9B6G,EAAMqM,mBACH7T,KAAKuS,aAAa7C,sBACrB1P,KAAKuS,aAAalD,sBAEfrP,KAAAuS,aAAajD,oBAAoB9H,EAAMqM,oBAG5C7T,KAAKuS,aAAa9C,sBAIhBjI,EAAM2C,SAAS2J,SAAW9T,KAAKsS,mBACH,IAA1B9K,EAAM2C,SAAS2J,QAEjB9T,KAAKuS,aAAa/D,gBAClBxO,KAAKsS,iBAAmB,GACf9K,EAAM2C,SAAS2J,OAAS9T,KAAKsS,kBAElB9K,EAAM2C,SAAS4J,MAAM/T,KAAKsS,kBAClCjP,QAAS2Q,GAAQhU,KAAKuS,aAAalH,WAAW2I,IACrDhU,KAAAsS,iBAAmB9K,EAAM2C,SAAS2J,SAIvC9T,KAAKuS,aAAa/D,gBACZhH,EAAA2C,SAAS9G,QAAS2Q,GAAQhU,KAAKuS,aAAalH,WAAW2I,IACxDhU,KAAAsS,iBAAmB9K,EAAM2C,SAAS2J,QAE3C,CAGM,mBAAA3R,GACN,MAAM8R,EAAiBC,aAAaC,QAAQ1U,GACtC+H,EAAQxH,KAAK+J,aAAaiB,WAE5B,GAAAxD,EAAMpF,UAAY6R,EAAgB,CACpC,MAAMlU,EAAcH,EAAWuC,oBAAoBqF,EAAMpF,SAAU6R,GAE5D,OADPjU,KAAK+J,aAAaG,SAAS,CAAEnK,iBACtB,CAAA,CAEF,OAAA,CAAA,CAGK,kBAAAoT,CAAmBtI,GAAyB,OAAA3K,EAAAF,KAAA,KAAA,YACxD6K,EAAEsG,iBAEF,MAAMiD,EAAMpU,KAAKkN,SAAS0C,aAAa/N,MAAMwS,OACvCjS,EAAWpC,KAAKkN,SAAS2C,cAAchO,MAAMwS,OAC7ChS,EAAcrC,KAAKkN,SAAS4C,iBAAiBjO,MAAMwS,OAEzD,IAAKD,IAAQhS,IAAaC,EAAa,OAGnC,IAEF,IADiB,IAAIuG,IAAIwL,GACXE,SAASC,WAAW,QAC1B,MAAA,IAAI3T,MAAM,kDAEXY,GAEP,YADKxB,KAAAuS,aAAa1E,UAAUlO,EAC5B,CAIF,MAAMI,EAAcH,EAAWuC,oBAAoBC,EAAUC,GAGxDrC,KAAAuS,aAAavC,sBAAqB,EAAM,kBAEzC,IACF,MAAMnJ,EAAa,IAAIjH,EAAWwU,EAAKrU,SACjC8G,EAAW5G,iBAGjB,MAAMuU,EAAWJ,EAAIK,QAAQ,MAAO,IACpCzU,KAAK+J,aAAa2K,cAAcF,EAAUpS,EAAUrC,GACvCmU,aAAAS,QAAQlV,EAA2B4C,SAG1CrC,KAAK4U,mBAAmBJ,EAAUzU,GAExCC,KAAKuS,aAAa5E,oBACXnM,GACPxB,KAAKuS,aAAa1E,UACfrM,EAAgBsJ,SAAW,sDAC9B,CACA,QACK9K,KAAAuS,aAAavC,sBAAqB,EAAO,WAAU,CAC1D,EAAA,CAGM,YAAAwD,GACFqB,QAAQ,8DACV7U,KAAK+J,aAAa+K,kBAClB9U,KAAKuS,aAAaxC,kBAClB/P,KAAKuS,aAAahE,mBAClBvO,KAAKuS,aAAanF,mBAClBpN,KAAK4S,uBACP,CAGY,qBAAAD,GAAuC,OAAAzS,EAAAF,KAAA,KAAA,YAE/C,IAACA,KAAKqS,eAAgB,CAClB,MAAA7K,EAAQxH,KAAK+J,aAAaiB,WAChC,IAAKxD,EAAM1H,UAAY0H,EAAMzH,YAG3B,OAFKC,KAAAuS,aAAa1E,UAAU,oDAC5B7N,KAAKuS,aAAanF,mBAIhB,IACGpN,KAAAuS,aAAatE,aAAY,SACxBjO,KAAK4U,mBAAmBpN,EAAM1H,QAAS0H,EAAMzH,mBAC5CyB,GAKP,OAJQP,QAAAO,MAAM,iCAAkCA,GAC3CxB,KAAAuS,aAAatE,aAAY,GACzBjO,KAAAuS,aAAa1E,UAAU,6CAC5B7N,KAAKuS,aAAanF,kBAClB,CACF,CAIGpN,KAAAuS,aAAatE,aAAY,GAE1B,UACIjO,KAAKqS,eAAgB1P,qBACpBnB,GACCP,QAAAO,MAAM,2BAA4BA,EAAK,CAC/C,QACKxB,KAAAuS,aAAatE,aAAY,EAAK,CACrC,EAAA,CAGM,oBAAA2E,GACF5S,KAAKqS,gBACPrS,KAAKqS,eAAetH,cAEtB/K,KAAKuS,aAAa9C,qBAAoB,CAGhC,YAAAzC,GACFhN,KAAKqS,gBACPrS,KAAKqS,eAAerF,cACtB,CAGM,uBAAA6F,GACN5R,QAAQC,IAAI,iEAAkElB,KAAKqS,gBAC/ErS,KAAKqS,eACFrS,KAAAqS,eAAenH,eAAc,GAElCjK,QAAQC,IAAI,oCACd,CAGM,qBAAA4R,GACN7R,QAAQC,IAAI,+DAAgElB,KAAKqS,gBAC7ErS,KAAKqS,eACFrS,KAAAqS,eAAenH,eAAc,GAElCjK,QAAQC,IAAI,oCACd,CAGY,kBAAA0T,CAAmB9U,EAAiBC,GAAoC,OAAAG,EAAAF,KAAA,KAAA,YACpF,MAAM6G,EAAa,IAAIjH,EAAWE,EAASC,SAIrC8G,EAAW5G,iBAEjBD,KAAK6G,WAAaA,EACb7G,KAAAiK,aAAe,IAAIrD,EAAaC,GACrC7G,KAAKqS,eAAiB,IAAIvI,EACxB9J,KAAK+J,aACLlD,EACA7G,KAAKkN,SAASuG,YAChB,EAAA,ECvRG,MAAMsB,EAIX,WAAAlV,GAFAG,KAAQgV,UAA8C,GAGpDhV,KAAKwH,MAAQ,CACX1H,QAASoU,aAAaC,QAAQ1U,IAA0B,GACxD2C,SAAU8R,aAAaC,QAAQ1U,IAA0B,GACzDM,YAAa,KACb+C,aAAc,KACdnC,OAAQ,eACRwJ,SAAU,GACV0J,kBAAmB,GACnBrR,eAAgB,KAChBC,YAAa,KACbC,YAAa,KACb0H,cAAe,GACfC,kBAAmB,KACnBqB,oBAAoB,EACpBuJ,kBAAmB,GACnBjO,oBAAoB,EACtB,CAGF,QAAAgE,GACE,OAAOhL,KAAKwH,KAAA,CAGd,QAAA0C,CAASgL,GACFlV,KAAAwH,MAAQ2N,EAAKA,EAAA,CAAA,EAAAnV,KAAKwH,OAAU0N,GACjClV,KAAKoV,iBAAgB,CAGvB,YAAA3K,CAAa9J,GACNX,KAAAkK,SAAS,CAAEvJ,UAAQ,CAG1B,UAAA0K,CAAWP,GACJ9K,KAAAkK,SAAS,CAAEC,SAAU,IAAInK,KAAKwH,MAAM2C,SAAUW,IAAU,CAG/D,aAAA0D,GACExO,KAAKkK,SAAS,CAAEC,SAAU,IAAI,CAGhC,aAAAuK,CAAc5U,EAAiBsC,EAAkBrC,GAC/CC,KAAKkK,SAAS,CAAEpK,UAASsC,WAAUrC,gBACtBmU,aAAAS,QAAQlV,EAAuBK,GAC/BoU,aAAAS,QAAQlV,EAAuB2C,EAAQ,CAGtD,eAAA0S,GACO9U,KAAAkK,SAAS,CAAEpK,QAAS,GAAIsC,SAAU,GAAIrC,YAAa,OAC3CmU,aAAAmB,WAAW5V,GACXyU,aAAAmB,WAAW5V,GACXyU,aAAAmB,WAAW5V,EAAyB,CAGnD,cAAA6K,CAAexH,EAAsByH,GACnC,MAAMmB,GAAsBnB,EAAWC,SAAS,SAChDxK,KAAKkK,SAAS,CAAEpH,eAAcmS,kBAAmB1K,EAAYmB,sBAAoB,CAGnF,gBAAAT,CAAiBM,GACfvL,KAAKkK,SAAS,CAAE2J,kBAAmBtI,GAAY,CAGjD,gBAAAC,CAAiBC,GACfzL,KAAKkK,SAAS,CAAE2J,kBAAmB7T,KAAKwH,MAAMqM,kBAAoBpI,GAAO,CAG3E,aAAAY,CAAcC,GACPtM,KAAAkK,SAAS,CAAEE,cAAe,IAAIpK,KAAKwH,MAAM4C,cAAekC,IAAW,CAG1E,eAAAC,GACE,MAAOD,KAAagJ,GAAQtV,KAAKwH,MAAM4C,cAEhC,OADFpK,KAAAkK,SAAS,CAAEE,cAAekL,EAAMjL,mBAA6B,MAAViC,OAAU,EAAAA,EAAAF,UAAW,OACtEE,CAAA,CAGT,mBAAAG,CAAoB8I,GAClBvV,KAAKkK,SAAS,CAAElD,mBAAoBuO,GAAW,CAGjD,SAAAvC,CAAUwC,GAER,OADKxV,KAAAgV,UAAUS,KAAKD,GACb,KACLxV,KAAKgV,UAAYhV,KAAKgV,UAAUU,OAAQC,GAAMA,IAAMH,GACtD,CAGM,eAAAJ,GACNpV,KAAKgV,UAAU3R,QAASmS,GAAaA,EAASxV,KAAKwH,OAAM,EC1FpDuH,SAAA8B,iBAAiB,mBAAoB,IAAY3Q,EAAA0V,EAAA,KAAA,YACxD,MAAM1I,ECJC,CACLG,aAAc0B,SAAS8G,eAAe,gBACtCrI,QAASuB,SAAS8G,eAAe,WACjC3C,WAAYnE,SAAS8G,eAAe,cACpCjG,aAAcb,SAAS8G,eAAe,WACtChG,cAAed,SAAS8G,eAAe,YACvC/F,iBAAkBf,SAAS8G,eAAe,eAC1C/H,YAAaiB,SAAS8G,eAAe,eACrC3F,WAAYnB,SAAS8G,eAAe,cACpCzC,YAAarE,SAAS8G,eAAe,eACrCxH,aAAcU,SAAS8G,eAAe,gBACtCvC,gBAAiBvE,SAAS8G,eAAe,mBACzCtC,UAAWxE,SAAS8G,eAAe,aACnCpD,UAAW1D,SAAS8G,eAAe,aACnCnD,WAAY3D,SAAS8G,eAAe,cACpCpH,cAAeM,SAAS8G,eAAe,iBACvCjH,WAAYG,SAAS8G,eAAe,cACpCpC,YAAa1E,SAAS8G,eAAe,eACrC1H,eAAgBY,SAAS8G,eAAe,mBDbpC9L,EAAe,IAAIgL,EACnBe,EAAM,IAAI1D,EAAIlF,EAAUnD,GAE1B,UACI+L,EAAI/C,aACHvR,GACCP,QAAAO,MAAM,4BAA6BA,EAAK,CAEpD,GAAC"}