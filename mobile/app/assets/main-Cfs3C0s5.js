var e,t,s=Object.defineProperty,n=Object.getOwnPropertyNames,o=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,a=(e,t,n)=>t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,l=(e,t)=>{for(var s in t||(t={}))i.call(t,s)&&a(e,s,t[s]);if(o)for(var s of o(t))r.call(t,s)&&a(e,s,t[s]);return e},c=(e,t,s)=>new Promise((n,o)=>{var i=e=>{try{a(s.next(e))}catch(t){o(t)}},r=e=>{try{a(s.throw(e))}catch(t){o(t)}},a=e=>e.done?n(e.value):Promise.resolve(e.value).then(i,r);a((s=s.apply(e,t)).next())}),u=(e={"assets/main-Cfs3C0s5.js"(e){!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const t="/wp-json/wp/v2/users/me",s="/wp-json/ai-commander/v1/realtime/session",n="/wp-json/ai-commander/v1/realtime/tool",o="/wp-json/ai-commander/v1/read-text",i="https://api.openai.com/v1/realtime",r="gpt-4o-realtime-preview-2025-06-03",a=48e3,u=1,d=16,h=!1,g=!1,m=!1,p=96e3,C=5e3,S="aicommander_site_url",y="aicommander_username",b="aicommander_app_password",E={status:{disconnected:"Press to start",connecting:"Connecting...",recording:"Listening...",processing:"Processing...",speaking:"Responding...",speaking_interruptible:"Press to interrupt",tool_wait:"Executing command...",idle:"Waiting...",error:"Error"},errors:{invalid_url:"Invalid URL. Enter a complete URL (e.g. https://www.yourshop.com)",invalid_credentials:"Invalid credentials. Check username and password.",access_denied:"Access denied. Check user permissions on the site.",connection_failed:"Unable to connect to WordPress site",session_failed:"Unable to start session",tool_execution_failed:"Tool execution failed",network_error:"Network error",data_channel_not_open:"Data channel not open",tts_failed:"Error in custom audio playback.",communication_error:"Communication error",unknown_error:"Unknown error",url_must_start_with_http:"URL must start with http:// or https://",connection_generic:"Unable to connect. Check your data and try again."},ui:{page_title:"AI Commander Voice Assistant",config_title:"AI Commander Voice Assistant",config_subtitle:"Enter your WordPress site URL and credentials",note_label:"Note:",note_text:'For the password, use an "Application Password" generated from your WordPress profile, not your regular password.',how_to_generate_link:"How to generate an app password →",site_url_label:"Site URL",site_url_placeholder:"https://www.yourshop.com",site_url_hint:"The complete URL of your WordPress INofficina site",username_label:"Username",username_placeholder:"john.doe",username_hint:"Your WordPress username",app_password_label:"App password",app_password_hint:"The application password generated in WordPress (not your regular password)",connect_button:"Connect",connecting_button:"Connecting...",office_name:"INofficina.it Assistant",change_config:"Change configuration",disconnect:"Disconnect",greeting_title:"Hello! 👋",greeting_text:"I'm the INofficina.it voice assistant. I can help you manage your workshop appointments.",suggestion_1:'💬 "Is license plate XX333TT our customer?"',suggestion_2:'📅 "Schedule maintenance for tomorrow"',suggestion_3:'🔍 "Show today\'s appointments"',disconnect_confirm:"Do you want to disconnect and delete saved credentials?"}};let T=l({},E);const v=new Proxy({},{get:(e,t)=>T.status[t]||E.status[t]||t}),f=new Proxy({},{get(e,t){const s=t.toLowerCase();return T.errors[s]||E.errors[s]||t}}),M=new Proxy({},{get(e,t){const s=t.toLowerCase();return T.ui[s]||E.ui[s]||t}});function w(){var e,t,s;document.title=M.page_title;const n=document.querySelector(".config-title");n&&(n.textContent=M.config_title);const o=document.querySelector(".config-subtitle");o&&(o.textContent=M.config_subtitle);const i=document.querySelector('div[style*="background: #f7fafc"]');i&&(i.innerHTML=`<strong>${M.note_label}</strong> ${M.note_text}\n      <a href="https://wordpress.org/documentation/article/application-passwords/" target="_blank" style="color: #667eea; text-decoration: underline;">${M.how_to_generate_link}</a>`);const r=document.querySelector('label[for="siteUrl"]');r&&(r.textContent=M.site_url_label);const a=document.getElementById("siteUrl");a&&(a.placeholder=M.site_url_placeholder);const l=null==(e=null==r?void 0:r.parentElement)?void 0:e.querySelector(".form-hint");l&&(l.textContent=M.site_url_hint);const c=document.querySelector('label[for="username"]');c&&(c.textContent=M.username_label);const u=document.getElementById("username");u&&(u.placeholder=M.username_placeholder);const d=null==(t=null==c?void 0:c.parentElement)?void 0:t.querySelector(".form-hint");d&&(d.textContent=M.username_hint);const h=document.querySelector('label[for="appPassword"]');h&&(h.textContent=M.app_password_label);const g=null==(s=null==h?void 0:h.parentElement)?void 0:s.querySelector(".form-hint");g&&(g.textContent=M.app_password_hint);const m=document.getElementById("connectBtn");m&&!m.disabled&&(m.textContent=M.connect_button);const p=document.getElementById("officeName");p&&(p.textContent=M.office_name);const C=document.querySelector("#changeConfigBtn span");C&&(C.textContent=M.change_config);const S=document.querySelector("#logoutBtn span");S&&(S.textContent=M.disconnect);const y=document.querySelector("#emptyState h2");y&&(y.textContent=M.greeting_title);const b=document.querySelector("#emptyState p");b&&(b.textContent=M.greeting_text);const E=document.querySelectorAll(".suggestion");E.length>=3&&(E[0].textContent=M.suggestion_1,E[1].textContent=M.suggestion_2,E[2].textContent=M.suggestion_3);const T=document.getElementById("statusText");T&&"Premi per iniziare"===T.textContent&&(T.textContent=v.disconnected)}class _{constructor(e,t){this.siteUrl=e,this.bearerToken=t}testConnection(){return c(this,null,function*(){const e=yield fetch(`${this.siteUrl}${t}`,{method:"GET",mode:"cors",credentials:"omit",headers:{Authorization:`Basic ${this.bearerToken}`}});if(!e.ok){if(401===e.status)throw new Error(f.INVALID_CREDENTIALS);if(403!==e.status)throw new Error(f.CONNECTION_FAILED);try{const t=yield e.json();if(!(t&&t.id&&t.name))throw new Error(f.ACCESS_DENIED);console.log("Authentication successful despite 403 status")}catch(s){throw new Error(f.ACCESS_DENIED)}}})}createSession(){return c(this,null,function*(){var e;const t=yield fetch(`${this.siteUrl}${s}`,{method:"POST",credentials:"omit",headers:{"Content-Type":"application/json",Authorization:`Basic ${this.bearerToken}`},body:JSON.stringify({})});if(!t.ok){const e=yield t.text();throw new Error(`${f.SESSION_FAILED}: ${e}`)}const n=yield t.json();if(!(null==(e=n.client_secret)?void 0:e.value))throw new Error("Invalid session response");return n})}executeTool(e){return c(this,null,function*(){const t=yield fetch(`${this.siteUrl}${n}`,{method:"POST",credentials:"omit",headers:{"Content-Type":"application/json",Authorization:`Basic ${this.bearerToken}`},body:JSON.stringify(e)});return yield t.json()})}getTextToSpeech(e,t){return c(this,null,function*(){const s=yield fetch(`${this.siteUrl}${o}`,{method:"POST",credentials:"omit",headers:{"Content-Type":"application/json",Authorization:`Basic ${this.bearerToken}`},body:JSON.stringify({text:e}),signal:t});if(!s.ok)throw new Error(`TTS request failed with status ${s.status}`);return yield s.blob()})}static generateBearerToken(e,t){return btoa(`${e}:${t}`)}fetchTranslations(){return c(this,null,function*(){try{const e=yield fetch(`${this.siteUrl}/wp-json/ai-commander/v1/translations`,{method:"GET",credentials:"omit",headers:{"Content-Type":"application/json"}});e.ok?(!function(e){T=e}(yield e.json()),w()):console.warn("Failed to fetch translations, using defaults")}catch(e){console.warn("Error fetching translations, using defaults:",e)}})}}class A{constructor(){this.peerConnection=null,this.dataChannel=null,this.localStream=null}startSession(e){return c(this,arguments,function*(e,t=r,s={}){this.peerConnection=new RTCPeerConnection,s.onTrack&&(this.peerConnection.ontrack=s.onTrack),this.peerConnection.getTransceivers().forEach(e=>{var t;if("audio"===(null==(t=e.sender.track)?void 0:t.kind)){const t=e.sender.getParameters();t.encodings=[{maxBitrate:p}],e.sender.setParameters(t)}}),this.localStream=yield navigator.mediaDevices.getUserMedia({audio:{sampleRate:a,channelCount:u,sampleSize:d,echoCancellation:h,noiseSuppression:g,autoGainControl:m}}),this.localStream.getTracks().forEach(e=>{this.peerConnection.addTrack(e,this.localStream)}),this.dataChannel=this.peerConnection.createDataChannel("oai-events",{ordered:!0}),s.onDataChannelOpen&&(this.dataChannel.onopen=s.onDataChannelOpen),s.onDataChannelMessage&&(this.dataChannel.onmessage=s.onDataChannelMessage),s.onDataChannelError&&(this.dataChannel.onerror=s.onDataChannelError);const n=yield this.peerConnection.createOffer();yield this.peerConnection.setLocalDescription(n);const o=yield fetch(`${i}?model=${t}`,{method:"POST",body:n.sdp,headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/sdp"}});if(!o.ok)throw new Error(`SDP negotiation failed: ${o.status}`);const l=yield o.text();yield this.peerConnection.setRemoteDescription({type:"answer",sdp:l})})}sendEvent(e){if(!this.dataChannel||"open"!==this.dataChannel.readyState)throw new Error("Data channel not open");this.dataChannel.send(JSON.stringify(e))}muteMicrophone(){this.localStream&&this.localStream.getAudioTracks().forEach(e=>{e.enabled=!1})}unmuteMicrophone(){this.localStream&&this.localStream.getAudioTracks().forEach(e=>{e.enabled=!0})}updateTurnDetection(e){console.log("[WebRTCService] updateTurnDetection called with mode:",e);const t={type:"session.update",session:{turn_detection:"server_vad"===e?{type:"server_vad",threshold:.5,prefix_padding_ms:300,silence_duration_ms:200}:null}};console.log("[WebRTCService] Sending session.update event:",t),this.sendEvent(t)}closeSession(){this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=null),this.dataChannel&&(this.dataChannel.close(),this.dataChannel=null),this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null)}}class I{constructor(e){this.apiService=e,this.isMobileAudioUnlocked=!1,this.globalAudioContext=null,this.isPlayingCustomTts=!1,this.currentAudioElement=null,this.currentAbortController=null}unlockMobileAudio(e){if(!this.isMobileAudioUnlocked){this.isMobileAudioUnlocked=!0;try{this.globalAudioContext=this.globalAudioContext||new(window.AudioContext||window.webkitAudioContext),"suspended"===this.globalAudioContext.state&&this.globalAudioContext.resume()}catch(t){console.warn("AudioContext initialisation failed:",t)}if(e){const t=e.muted;e.muted=!0;const s=e.play();s&&"function"==typeof s.then?s.then(()=>{e.pause(),e.currentTime=0,e.muted=t,console.log("[AI-Commander] Mobile audio unlocked")}).catch(s=>{console.warn("Mobile audio unlock play() rejected:",s),e.muted=t}):e.muted=t}}}playCustomTtsAudio(e,t,s,n){return c(this,null,function*(){if(e){console.log("[AudioService] Playing custom TTS for:",e);try{this.isPlayingCustomTts=!0,this.currentAudioElement=t,s&&s(),console.log("[AudioService] Fetching TTS audio from API..."),this.currentAbortController=new AbortController;const n=yield this.apiService.getTextToSpeech(e,this.currentAbortController.signal);if(console.log("[AudioService] Received audio blob, size:",n.size),!this.isPlayingCustomTts||!t)return;t.dataset.objectUrl&&(URL.revokeObjectURL(t.dataset.objectUrl),delete t.dataset.objectUrl),t.srcObject=null;const o=URL.createObjectURL(n);t.dataset.objectUrl=o,t.src=o,yield t.play(),yield new Promise((e,s)=>{const n=()=>{this.isPlayingCustomTts||(t.pause(),e())};t.onended=()=>e(),t.onerror=()=>s(new Error("Audio playback error"));const o=setInterval(()=>{n(),this.isPlayingCustomTts||clearInterval(o)},100),i=e;e=()=>{clearInterval(o),i()}}),URL.revokeObjectURL(o),delete t.dataset.objectUrl}catch(o){if(!(o instanceof Error&&"AbortError"===o.name))throw console.error("Error during custom TTS playback:",o),new Error(f.TTS_FAILED);console.log("[AudioService] TTS request was aborted")}finally{this.currentAbortController=null,this.isPlayingCustomTts=!1,this.currentAudioElement=null,n&&n()}}else console.log("[AudioService] No text provided for TTS")})}interruptCustomTts(){this.currentAbortController&&(this.currentAbortController.abort(),this.currentAbortController=null,console.log("[AudioService] Aborted TTS request")),this.isPlayingCustomTts&&this.currentAudioElement&&(this.isPlayingCustomTts=!1,this.currentAudioElement.pause(),this.currentAudioElement.currentTime=0,this.currentAudioElement.dataset.objectUrl&&(URL.revokeObjectURL(this.currentAudioElement.dataset.objectUrl),delete this.currentAudioElement.dataset.objectUrl),console.log("Custom TTS interrupted by user"))}cleanup(e){this.interruptCustomTts(),e&&(e.pause(),e.currentTime=0,e.srcObject=null,e.src="",e.dataset.objectUrl&&(URL.revokeObjectURL(e.dataset.objectUrl),delete e.dataset.objectUrl),e.onended=null)}get isPlayingTts(){return this.isPlayingCustomTts}}class k{constructor(e,t,s){this.stateManager=e,this.apiService=t,this.audioElement=s,this.webrtcService=new A,this.audioService=new I(t)}startSession(){return c(this,null,function*(){var e;try{this.stateManager.setState({status:"connecting",messages:[],toolCallQueue:[],currentToolCallId:null});const t=yield this.apiService.createSession();this.stateManager.setSessionData(t.client_secret.value,t.modalities||["text","audio"]),console.log("Session modalities:",t.modalities),console.log("Custom TTS enabled:",!(null==(e=t.modalities)?void 0:e.includes("audio"))),yield this.webrtcService.startSession(t.client_secret.value,t.model,{onDataChannelOpen:()=>{this.stateManager.updateStatus("recording")},onDataChannelMessage:e=>this.handleServerEvent(e),onDataChannelError:e=>{console.error("Data channel error:",e),this.handleError(f.COMMUNICATION_ERROR)},onTrack:e=>{this.audioElement&&e.streams&&e.streams[0]&&(this.audioElement.srcObject=e.streams[0],this.audioElement.play().catch(e=>console.error("Audio play error:",e)))}})}catch(t){console.error("Session start error:",t),this.handleError(t.message||f.SESSION_FAILED),this.stopSession()}})}stopSession(){this.stateManager.getState().isPlayingCustomTts&&this.audioService.interruptCustomTts(),this.webrtcService.closeSession(),this.audioService.cleanup(this.audioElement),this.stateManager.updateStatus("disconnected"),this.stateManager.updateTranscript("")}setVadEnabled(e){console.log("[SessionManager] setVadEnabled called with:",e);try{this.webrtcService.updateTurnDetection(e?"server_vad":"none"),console.log(`[SessionManager] VAD ${e?"enabled":"disabled"} - session update sent`),e&&(console.log("[SessionManager] Committing audio buffer after press-to-talk"),this.webrtcService.sendEvent({type:"input_audio_buffer.commit"}),console.log("[SessionManager] Creating response after press-to-talk"),this.webrtcService.sendEvent({type:"response.create"}))}catch(t){console.error("[SessionManager] Failed to update VAD:",t)}}handleServerEvent(e){return c(this,null,function*(){try{const t=JSON.parse(e.data);console.log("Server event:",t.type,t);const s=this.stateManager.getState();switch(t.type){case"input_audio_buffer.speech_started":this.webrtcService.unmuteMicrophone(),this.stateManager.updateStatus("recording");break;case"input_audio_buffer.speech_stopped":this.stateManager.updateStatus("processing");break;case"conversation.item.input_audio_transcription.completed":this.stateManager.addMessage({type:"user",content:t.transcript});break;case"response.created":this.stateManager.updateTranscript("");break;case"response.audio_transcript.delta":case"response.text.delta":this.stateManager.appendTranscript(t.delta||"");break;case"response.audio.delta":s.isCustomTtsEnabled||this.stateManager.updateStatus("speaking");break;case"response.function_call_arguments.delta":"tool_wait"!==s.status&&this.stateManager.updateStatus("tool_wait");break;case"response.done":yield this.handleResponseDone(t);break;case"output_audio_buffer.stopped":s.isCustomTtsEnabled||this.stateManager.updateStatus("idle");break;case"error":console.error("API Error:",t),this.handleError(t.message||f.UNKNOWN_ERROR)}}catch(t){console.error("Error parsing server event:",t)}})}handleResponseDone(e){return c(this,null,function*(){var t,s,n,o;if(this.stateManager.updateTranscript(""),"failed"===e.response.status)return void this.stateManager.updateStatus("error");const i=null==(o=null==(n=null==(s=null==(t=e.response)?void 0:t.output)?void 0:s[0])?void 0:n.content)?void 0:o[0],r=(null==i?void 0:i.text)||(null==i?void 0:i.transcript);r&&this.stateManager.addMessage({type:"assistant",content:r}),this.stateManager.getState().isCustomTtsEnabled&&r&&(yield this.playCustomTts(r)),e.response.output&&e.response.output.forEach(e=>{"function_call"===e.type&&e.call_id&&e.name&&e.arguments&&this.stateManager.queueToolCall({name:e.name,arguments:e.arguments,call_id:e.call_id})});const a=this.stateManager.dequeueToolCall();a&&(yield this.processToolCall(a))})}playCustomTts(e){return c(this,null,function*(){console.log("[SessionManager] Starting custom TTS for text:",e);try{yield this.audioService.playCustomTtsAudio(e,this.audioElement,()=>{console.log("[SessionManager] Custom TTS started"),this.stateManager.setPlayingCustomTts(!0),this.stateManager.updateStatus("speaking"),this.webrtcService.muteMicrophone()},()=>{console.log("[SessionManager] Custom TTS ended"),"disconnected"!==this.stateManager.getState().status&&(this.stateManager.setPlayingCustomTts(!1),this.webrtcService.unmuteMicrophone(),this.stateManager.updateStatus("recording"))})}catch(t){console.error("Custom TTS error:",t),"disconnected"!==this.stateManager.getState().status&&this.handleError(f.TTS_FAILED)}})}processToolCall(e){return c(this,null,function*(){try{const t=yield this.apiService.executeTool({tool_name:e.name,arguments:e.arguments});t.error?this.sendFunctionResult(e.call_id,{error:!0,message:t.message||f.TOOL_EXECUTION_FAILED}):this.sendFunctionResult(e.call_id,t)}catch(s){this.sendFunctionResult(e.call_id,{error:!0,message:f.NETWORK_ERROR})}const t=this.stateManager.dequeueToolCall();t&&(yield this.processToolCall(t))})}sendFunctionResult(e,t){try{this.webrtcService.sendEvent({type:"conversation.item.create",item:{type:"function_call_output",call_id:e,output:JSON.stringify(t)}}),this.webrtcService.sendEvent({type:"response.create"})}catch(s){this.handleError(f.DATA_CHANNEL_NOT_OPEN)}}interruptTts(){this.stateManager.getState().isPlayingCustomTts?this.audioService.interruptCustomTts():this.stopSession()}handleError(e){console.error("Error:",e),this.stateManager.updateStatus("error")}}class P{constructor(e){this.elements=e,this.typingMessageDiv=null}showConfigScreen(){this.elements.configScreen.style.display="flex",this.elements.mainApp.classList.remove("active")}showMainApp(){this.elements.configScreen.style.display="none",this.elements.mainApp.classList.add("active")}showError(e){this.elements.configError.textContent=e,this.elements.configError.style.display="block",setTimeout(()=>{this.elements.configError.style.display="none"},C)}showLoading(e){this.elements.loadingOverlay.style.display=e?"flex":"none"}toggleSettingsMenu(){this.elements.settingsMenu.classList.toggle("active")}hideSettingsMenu(){this.elements.settingsMenu.classList.remove("active")}clearMessages(){this.elements.chatContainer.innerHTML="",this.elements.chatContainer.appendChild(this.elements.emptyState)}addMessage(e){this.elements.emptyState.parentNode&&this.elements.emptyState.remove();const t=document.createElement("div");t.className=`chat-message ${e.type}`;const s=document.createElement("div");s.className="message-bubble",s.textContent=e.content,t.appendChild(s),this.elements.chatContainer.appendChild(t),this.elements.chatContainer.scrollTop=this.elements.chatContainer.scrollHeight}showTypingIndicator(){this.elements.emptyState.parentNode&&this.elements.emptyState.remove(),this.typingMessageDiv=document.createElement("div"),this.typingMessageDiv.className="chat-message assistant",this.typingMessageDiv.id="typingMessage";const e=document.createElement("div");e.className="message-bubble typing",e.innerHTML='\n      <span class="typing-dot"></span>\n      <span class="typing-dot"></span>\n      <span class="typing-dot"></span>\n    ',this.typingMessageDiv.appendChild(e),this.elements.chatContainer.appendChild(this.typingMessageDiv),this.elements.chatContainer.scrollTop=this.elements.chatContainer.scrollHeight}updateTypingMessage(e){if(this.typingMessageDiv&&e){const t=this.typingMessageDiv.querySelector(".message-bubble");t&&(t.className="message-bubble",t.textContent=e,this.elements.chatContainer.scrollTop=this.elements.chatContainer.scrollHeight)}}hideTypingIndicator(){this.typingMessageDiv&&(this.typingMessageDiv.remove(),this.typingMessageDiv=null)}hasTypingIndicator(){return null!==this.typingMessageDiv}populateConfigForm(e,t){this.elements.siteUrlInput.value=e,this.elements.usernameInput.value=t,this.elements.appPasswordInput.value=""}clearConfigForm(){this.elements.siteUrlInput.value="",this.elements.usernameInput.value="",this.elements.appPasswordInput.value=""}disableConnectButton(e,t){this.elements.connectBtn.disabled=e,t&&(this.elements.connectBtn.textContent=t)}}class L{constructor(e,t,s){this.currentState="disconnected",this.pressTimer=null,this.isPressAndHold=!1,this.pressStartTime=0,this.PRESS_HOLD_DELAY=300,this.MIN_CLICK_TIME=50,this.buttonElement=e,this.statusElement=t,this.callbacks=s,this.setupEventListeners()}setupEventListeners(){this.buttonElement.addEventListener("click",()=>{this.isPressAndHold||0!==this.pressStartTime||this.handleClick()}),this.buttonElement.addEventListener("mousedown",e=>this.handlePressStart(e)),this.buttonElement.addEventListener("mouseup",e=>this.handlePressEnd(e)),this.buttonElement.addEventListener("mouseleave",e=>this.handlePressCancel(e)),this.buttonElement.addEventListener("touchstart",e=>this.handlePressStart(e),{passive:!1}),this.buttonElement.addEventListener("touchend",e=>this.handlePressEnd(e),{passive:!1}),this.buttonElement.addEventListener("touchcancel",e=>this.handlePressCancel(e))}handlePressStart(e){console.log("[MicButton] Press start event:",e.type,"Current state:",this.currentState),"touchstart"===e.type&&e.preventDefault(),this.pressStartTime=Date.now(),this.isPressAndHold=!1,"recording"===this.currentState?(console.log("[MicButton] Starting press-and-hold timer (300ms)"),this.pressTimer=window.setTimeout(()=>{this.isPressAndHold=!0,console.log("[MicButton] Press-and-hold ACTIVATED"),this.buttonElement.classList.add("press-and-hold"),this.callbacks.onPressAndHoldStart&&(console.log("[MicButton] Calling onPressAndHoldStart callback"),this.callbacks.onPressAndHoldStart())},this.PRESS_HOLD_DELAY)):console.log("[MicButton] Not in recording state, skipping press-and-hold")}handlePressEnd(e){const t=Date.now()-this.pressStartTime;console.log("[MicButton] Press end event:",e.type,"Duration:",t,"ms","isPressAndHold:",this.isPressAndHold),"touchend"===e.type&&e.preventDefault(),this.pressTimer&&(clearTimeout(this.pressTimer),this.pressTimer=null),this.isPressAndHold&&this.callbacks.onPressAndHoldEnd?(console.log("[MicButton] Ending press-and-hold, calling onPressAndHoldEnd callback"),this.buttonElement.classList.remove("press-and-hold"),this.callbacks.onPressAndHoldEnd(),this.isPressAndHold=!1):this.pressStartTime>0&&t>=this.MIN_CLICK_TIME&&t<this.PRESS_HOLD_DELAY&&(console.log("[MicButton] Normal click detected, calling handleClick()"),this.handleClick()),this.isPressAndHold=!1,this.pressStartTime=0}handlePressCancel(e){console.log("[MicButton] Press cancelled"),this.pressTimer&&(clearTimeout(this.pressTimer),this.pressTimer=null),this.isPressAndHold&&this.callbacks.onPressAndHoldEnd&&(console.log("[MicButton] Press-and-hold cancelled, calling onPressAndHoldEnd"),this.buttonElement.classList.remove("press-and-hold"),this.callbacks.onPressAndHoldEnd()),this.isPressAndHold=!1,this.pressStartTime=0}handleClick(){switch(this.currentState){case"disconnected":case"error":this.callbacks.onStartRecording();break;case"speaking":this.callbacks.onInterruptTts();break;case"recording":case"processing":case"tool_wait":case"idle":this.callbacks.onStopRecording();break;case"connecting":break;default:console.warn("Unknown mic button state:",this.currentState)}}setState(e,t={}){console.log(`Mic button: ${this.currentState} → ${e}`),this.currentState=e,this.updateUI(e,t)}updateUI(e,t={}){switch(this.buttonElement.className="mic-button",this.buttonElement.innerHTML="",this.buttonElement.disabled=!1,e){case"disconnected":this.statusElement.textContent=v.disconnected,this.statusElement.className="status-text",this.buttonElement.innerHTML=this.getMicIcon();break;case"connecting":this.statusElement.textContent=v.connecting,this.statusElement.className="status-text",this.buttonElement.innerHTML='<div class="spinner"></div>',this.buttonElement.disabled=!0;break;case"recording":this.statusElement.textContent=v.recording,this.statusElement.className="status-text",this.buttonElement.classList.add("recording"),this.buttonElement.innerHTML=this.getSoundWaveIcon();break;case"processing":this.statusElement.textContent=v.processing,this.statusElement.className="status-text",this.buttonElement.innerHTML='<div class="spinner"></div>';break;case"speaking":this.statusElement.textContent=v.speaking_interruptible,this.statusElement.className="status-text",this.buttonElement.disabled=!1,this.buttonElement.innerHTML=this.getStopIcon();break;case"tool_wait":this.statusElement.textContent=v.tool_wait,this.statusElement.className="status-text",this.buttonElement.innerHTML='<div class="spinner"></div>';break;case"idle":this.statusElement.textContent=v.idle,this.statusElement.className="status-text",this.buttonElement.innerHTML=this.getStopIcon();break;case"error":this.statusElement.textContent=t.message||v.error,this.statusElement.className="status-text error",this.buttonElement.innerHTML=this.getMicIcon()}}getMicIcon(){return'\n      <svg viewBox="0 0 24 24" fill="currentColor">\n        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>\n        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>\n      </svg>\n    '}getStopIcon(){return'\n      <svg viewBox="0 0 24 24" fill="currentColor">\n        <rect x="6" y="6" width="12" height="12" rx="2"/>\n      </svg>\n    '}getSoundWaveIcon(){return'\n      <div class="sound-wave">\n        <span class="sound-bar"></span>\n        <span class="sound-bar"></span>\n        <span class="sound-bar"></span>\n        <span class="sound-bar"></span>\n        <span class="sound-bar"></span>\n      </div>\n    '}}class x{constructor(e,t){this.elements=e,this.stateManager=t,this.sessionManager=null,this.apiService=null,this.audioService=null,this.lastMessageCount=0,this.uiController=new P(e),this.micController=new L(e.micButton,e.statusText,{onStartRecording:()=>this.startRecordingSession(),onStopRecording:()=>this.stopRecordingSession(),onInterruptTts:()=>this.interruptTts(),onPressAndHoldStart:()=>this.handlePressAndHoldStart(),onPressAndHoldEnd:()=>this.handlePressAndHoldEnd()})}init(){return c(this,null,function*(){this.setupEventListeners(),this.stateManager.subscribe(e=>this.onStateChange(e));const e=this.stateManager.getState();e.siteUrl&&this.generateBearerToken()?(this.elements.siteUrlInput.value=e.siteUrl,this.elements.usernameInput.value=e.username,this.uiController.showMainApp()):this.uiController.showConfigScreen()})}setupEventListeners(){this.elements.configForm.addEventListener("submit",e=>this.handleConfigSubmit(e)),this.elements.settingsBtn.addEventListener("click",e=>{e.stopPropagation(),this.uiController.toggleSettingsMenu()}),this.elements.changeConfigBtn.addEventListener("click",()=>{this.uiController.hideSettingsMenu(),this.uiController.showConfigScreen(),this.uiController.populateConfigForm(this.stateManager.getState().siteUrl,this.stateManager.getState().username)}),this.elements.logoutBtn.addEventListener("click",()=>this.handleLogout()),this.elements.micButton.addEventListener("click",()=>{this.audioService&&this.audioService.unlockMobileAudio(this.elements.remoteAudio)},{once:!0}),document.addEventListener("click",e=>{this.elements.settingsBtn.contains(e.target)||this.elements.settingsMenu.contains(e.target)||this.uiController.hideSettingsMenu()})}onStateChange(e){this.micController.setState(e.status),e.currentTranscript?(this.uiController.hasTypingIndicator()||this.uiController.showTypingIndicator(),this.uiController.updateTypingMessage(e.currentTranscript)):this.uiController.hideTypingIndicator(),e.messages.length!==this.lastMessageCount&&(0===e.messages.length?(this.uiController.clearMessages(),this.lastMessageCount=0):e.messages.length>this.lastMessageCount?(e.messages.slice(this.lastMessageCount).forEach(e=>this.uiController.addMessage(e)),this.lastMessageCount=e.messages.length):(this.uiController.clearMessages(),e.messages.forEach(e=>this.uiController.addMessage(e)),this.lastMessageCount=e.messages.length))}generateBearerToken(){const e=localStorage.getItem(b),t=this.stateManager.getState();if(t.username&&e){const s=_.generateBearerToken(t.username,e);return this.stateManager.setState({bearerToken:s}),!0}return!1}handleConfigSubmit(e){return c(this,null,function*(){e.preventDefault();const t=this.elements.siteUrlInput.value.trim(),s=this.elements.usernameInput.value.trim(),n=this.elements.appPasswordInput.value.trim();if(!t||!s||!n)return;try{if(!new URL(t).protocol.startsWith("http"))throw new Error(f.URL_MUST_START_WITH_HTTP)}catch(i){return void this.uiController.showError(f.INVALID_URL)}const o=_.generateBearerToken(s,n);this.uiController.disableConnectButton(!0,M.CONNECTING_BUTTON);try{const e=new _(t,o);e.fetchTranslations().catch(console.warn),yield e.testConnection();const i=t.replace(/\/$/,"");this.stateManager.setSiteConfig(i,s,o),localStorage.setItem(b,n),yield this.initializeServices(i,o),this.uiController.showMainApp()}catch(i){this.uiController.showError(i.message||f.CONNECTION_GENERIC)}finally{this.uiController.disableConnectButton(!1,M.CONNECT_BUTTON)}})}handleLogout(){confirm(M.DISCONNECT_CONFIRM)&&(this.stateManager.clearSiteConfig(),this.uiController.clearConfigForm(),this.uiController.hideSettingsMenu(),this.uiController.showConfigScreen(),this.stopRecordingSession())}startRecordingSession(){return c(this,null,function*(){if(!this.sessionManager){const t=this.stateManager.getState();if(!t.siteUrl||!t.bearerToken)return this.uiController.showError("Credenziali non trovate. Accedi nuovamente."),void this.uiController.showConfigScreen();try{this.uiController.showLoading(!0),console.log("initializeServices"),yield this.initializeServices(t.siteUrl,t.bearerToken)}catch(e){return console.error("Failed to initialize services:",e),this.uiController.showLoading(!1),this.uiController.showError("Sessione scaduta. Accedi nuovamente."),void this.uiController.showConfigScreen()}}this.uiController.showLoading(!0);try{yield this.sessionManager.startSession()}catch(e){console.error("Failed to start session:",e)}finally{this.uiController.showLoading(!1)}})}stopRecordingSession(){this.sessionManager&&this.sessionManager.stopSession(),this.uiController.hideTypingIndicator()}interruptTts(){this.sessionManager&&this.sessionManager.interruptTts()}handlePressAndHoldStart(){console.log("[App] handlePressAndHoldStart called, sessionManager exists:",!!this.sessionManager),this.sessionManager?this.sessionManager.setVadEnabled(!1):console.log("[App] No sessionManager available")}handlePressAndHoldEnd(){console.log("[App] handlePressAndHoldEnd called, sessionManager exists:",!!this.sessionManager),this.sessionManager?this.sessionManager.setVadEnabled(!0):console.log("[App] No sessionManager available")}initializeServices(e,t){return c(this,null,function*(){const s=new _(e,t);s.fetchTranslations().catch(console.warn),yield s.testConnection(),this.apiService=s,this.audioService=new I(s),this.sessionManager=new k(this.stateManager,s,this.elements.remoteAudio)})}}class N{constructor(){this.listeners=[],this.state={siteUrl:localStorage.getItem(S)||"",username:localStorage.getItem(y)||"",bearerToken:null,sessionToken:null,status:"disconnected",messages:[],currentTranscript:"",peerConnection:null,dataChannel:null,localStream:null,toolCallQueue:[],currentToolCallId:null,isCustomTtsEnabled:!1,sessionModalities:[],isPlayingCustomTts:!1}}getState(){return this.state}setState(e){this.state=l(l({},this.state),e),this.notifyListeners()}updateStatus(e){this.setState({status:e})}addMessage(e){this.setState({messages:[...this.state.messages,e]})}clearMessages(){this.setState({messages:[]})}setSiteConfig(e,t,s){this.setState({siteUrl:e,username:t,bearerToken:s}),localStorage.setItem(S,e),localStorage.setItem(y,t)}clearSiteConfig(){this.setState({siteUrl:"",username:"",bearerToken:null}),localStorage.removeItem(S),localStorage.removeItem(y),localStorage.removeItem(b)}setSessionData(e,t){const s=!t.includes("audio");this.setState({sessionToken:e,sessionModalities:t,isCustomTtsEnabled:s})}updateTranscript(e){this.setState({currentTranscript:e})}appendTranscript(e){this.setState({currentTranscript:this.state.currentTranscript+e})}queueToolCall(e){this.setState({toolCallQueue:[...this.state.toolCallQueue,e]})}dequeueToolCall(){const[e,...t]=this.state.toolCallQueue;return this.setState({toolCallQueue:t,currentToolCallId:(null==e?void 0:e.call_id)||null}),e}setPlayingCustomTts(e){this.setState({isPlayingCustomTts:e})}subscribe(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(t=>t!==e)}}notifyListeners(){this.listeners.forEach(e=>e(this.state))}}document.addEventListener("DOMContentLoaded",()=>c(e,null,function*(){const e={configScreen:document.getElementById("configScreen"),mainApp:document.getElementById("mainApp"),configForm:document.getElementById("configForm"),siteUrlInput:document.getElementById("siteUrl"),usernameInput:document.getElementById("username"),appPasswordInput:document.getElementById("appPassword"),configError:document.getElementById("configError"),connectBtn:document.getElementById("connectBtn"),settingsBtn:document.getElementById("settingsBtn"),settingsMenu:document.getElementById("settingsMenu"),changeConfigBtn:document.getElementById("changeConfigBtn"),logoutBtn:document.getElementById("logoutBtn"),micButton:document.getElementById("micButton"),statusText:document.getElementById("statusText"),chatContainer:document.getElementById("chatContainer"),emptyState:document.getElementById("emptyState"),remoteAudio:document.getElementById("remoteAudio"),loadingOverlay:document.getElementById("loadingOverlay")},t=new N,s=new x(e,t);w();const n=localStorage.getItem(S);n&&new _(n,"").fetchTranslations().catch(console.warn);try{yield s.init()}catch(o){console.error("Failed to initialize app:",o)}}))}},function(){return t||(0,e[n(e)[0]])((t={exports:{}}).exports,t),t.exports});export default u();
//# sourceMappingURL=main-Cfs3C0s5.js.map
